<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="pl" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Funkcje analityczne w SQL - Samouczek Programisty</title>
<meta name="description" content="W tym artykule opisuję funkcje analityczne w SQL. Po lekturze tego artykułu będziesz wiedzieć czym są funkcje analityczne i czym różnią się od funkcji agregujących. Na licznych przykładach poznasz składnię funkcji analitycznych. Te przykłady pozwolą Ci przetestować zapytania analityczne samodzielnie. W artykule czeka na Ciebie zestaw ćwiczeń, które pomogą Ci utrwalić zdobytą wiedzę.">


  <meta name="author" content="Marcin Pietraszek">


<meta property="og:type" content="article">
<meta property="og:locale" content="pl">
<meta property="og:site_name" content="Samouczek Programisty">
<meta property="og:title" content="Funkcje analityczne w SQL">
<meta property="og:url" content="https://www.samouczekprogramisty.pl/funkcje-analityczne-w-sql/">


  <meta property="og:description" content="W tym artykule opisuję funkcje analityczne w SQL. Po lekturze tego artykułu będziesz wiedzieć czym są funkcje analityczne i czym różnią się od funkcji agregujących. Na licznych przykładach poznasz składnię funkcji analitycznych. Te przykłady pozwolą Ci przetestować zapytania analityczne samodzielnie. W artykule czeka na Ciebie zestaw ćwiczeń, które pomogą Ci utrwalić zdobytą wiedzę.">



  <meta property="og:image" content="https://www.samouczekprogramisty.pl/assets/images/2021/0504-funkcje-analityczne-w-sql/funkcje_analityczne_w_sql_artykul.jpg">





  <meta property="article:published_time" content="2021-05-04T00:00:00+02:00">



  <meta property="article:modified_time" content="2021-05-04T20:30:19+02:00">



  

  


<link rel="canonical" href="https://www.samouczekprogramisty.pl/funkcje-analityczne-w-sql/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Marcin Pietraszek",
      "url": "https://www.samouczekprogramisty.pl/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Samouczek Programisty Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <link rel="shortcut icon" href="/assets/images/favicon.ico" /> 
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo.gif" alt=""></a>
        
        <a class="site-title" href="/">
          Samouczek Programisty
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/kurs-programowania-java/">Kurs programowania Java</a>
            </li><li class="masthead__menu-item">
              <a href="/kurs-aplikacji-webowych/">Kurs aplikacji webowych</a>
            </li><li class="masthead__menu-item">
              <a href="/kurs-sql/">Kurs SQL</a>
            </li><li class="masthead__menu-item">
              <a href="/kontakt/">Kontakt</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Przełącz menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('/assets/images/2021/0504-funkcje-analityczne-w-sql/funkcje_analityczne_w_sql_artykul.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Funkcje analityczne w SQL

        
      </h1>
      
        <p class="page__lead">W tym artykule opisuję funkcje analityczne w SQL. Po lekturze tego artykułu będziesz wiedzieć czym są funkcje analityczne i czym różnią się od funkcji agregujących. Na licznych przykładach poznasz składnię funkcji analitycznych. Te przykłady pozwolą Ci przetestować zapytania analityczne samodzielnie. W artykule czeka na Ciebie zestaw ćwiczeń, które pomogą Ci utrwalić zdobytą wiedzę.
</p>
      
      
        <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  15 minut(y)

</p>
      
      
      
    </div>
  
  
    <span class="page__hero-caption"><a href="https://unsplash.com/photos/Fd9tUmRBJzk">© Rob Wingate</a>
</span>
  
</div>




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://www.samouczekprogramisty.pl/" itemprop="item"><span itemprop="name">Strona główna</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Funkcje analityczne w SQL</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">

  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Funkcje analityczne w SQL">
    <meta itemprop="description" content="W tym artykule opisuję funkcje analityczne w SQL. Po lekturze tego artykułu będziesz wiedzieć czym są funkcje analityczne i czym różnią się od funkcji agregujących. Na licznych przykładach poznasz składnię funkcji analitycznych. Te przykłady pozwolą Ci przetestować zapytania analityczne samodzielnie. W artykule czeka na Ciebie zestaw ćwiczeń, które pomogą Ci utrwalić zdobytą wiedzę.">
    <meta itemprop="datePublished" content="May 04, 2021">
    <meta itemprop="dateModified" content="May 04, 2021">

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        <aside class="sidebar__right ">
          
          <nav class="toc">
            <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Spis treści</h4></header>
            <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#czym-są-funkcje-analityczne-w-sql">Czym są funkcje analityczne w SQL</a>
<ul>
<li class="toc-entry toc-h4"><a href="#pozostałe-funkcje-agregujące">Pozostałe funkcje agregujące</a></li>
<li class="toc-entry toc-h3"><a href="#klauzula-partition-by">Klauzula PARTITION BY</a></li>
<li class="toc-entry toc-h3"><a href="#kiedy-obliczana-jest-wartość-funkcji-analitycznej">Kiedy obliczana jest wartość funkcji analitycznej</a></li>
<li class="toc-entry toc-h3"><a href="#czym-jest-okno">Czym jest okno</a></li>
<li class="toc-entry toc-h3"><a href="#ćwiczenia-do-samodzielnego-wykonania">Ćwiczenia do samodzielnego wykonania</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#sortowanie-w-funkcjach-analitycznych">Sortowanie w funkcjach analitycznych</a>
<ul>
<li class="toc-entry toc-h3"><a href="#partycje-a-sortowanie">Partycje a sortowanie</a></li>
<li class="toc-entry toc-h3"><a href="#ćwiczenia-do-samodzielnego-wykonania-1">Ćwiczenia do samodzielnego wykonania</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#unikanie-duplikacji--nazwane-partycje">Unikanie duplikacji – nazwane partycje</a></li>
<li class="toc-entry toc-h2"><a href="#funkcje-okna">Funkcje okna</a>
<ul>
<li class="toc-entry toc-h3"><a href="#okno-typu-rows">Okno typu ROWS</a></li>
<li class="toc-entry toc-h3"><a href="#okno-typu-groups">Okno typu GROUPS</a></li>
<li class="toc-entry toc-h3"><a href="#okno-typu-range">Okno typu RANGE</a></li>
<li class="toc-entry toc-h3"><a href="#filtrowanie-okna">Filtrowanie okna</a></li>
<li class="toc-entry toc-h3"><a href="#lista-funkcji">Lista funkcji</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#funkcje-analityczne-a-klauzula-where">Funkcje analityczne a klauzula WHERE</a></li>
<li class="toc-entry toc-h2"><a href="#dodatkowe-materiały-do-nauki">Dodatkowe materiały do nauki</a></li>
<li class="toc-entry toc-h2"><a href="#podsumowanie">Podsumowanie</a></li>
</ul>
          </nav>
          <hr />
          
          <div class="mailerlite__form">
            <script type="text/javascript" src="https://static.mailerlite.com/data/webforms/698980/y1i5k0.js?v7"></script>
          </div>
          <hr />
          <div class="fb-page">
            <a href="https://www.facebook.com/SamouczekProgramisty"><img src="/assets/images/facebook_logo.gif" alt="Profil Samouczka na Facebooku"/></a>
          </div>
        </aside>
        
<div class="notice--info">
  
<p>To jest jeden z artykułów w ramach <a href="https://www.samouczekprogramisty.pl/kurs-sql">praktycznego kursu SQL</a>. Proszę zapoznaj się z pozostałymi częściami, mogą one być pomocne w zrozumieniu materiału z tego artykułu.</p>

<p>Każde zapytanie z kursu możesz wykonać samodzielnie. Potrzebujesz do tego środowiska opisanego w <a href="/pobieranie-danych-z-bazy-select/">pierwszym artykule kursu</a>. Bardzo mocno Cię do tego zachęcam. Moim zdaniem najwięcej nauczysz się samodzielnie eksperymentując z zapytaniami.</p>

</div>

<p class="notice--info">W tym artykule używam funkcji SQLite, które zostały dodane w wersji 3.28.0. Jeśli używasz SQLite do eksperymentowania upewnij się, że korzystasz z wersji 3.28.0 bądź nowszej. Możesz to zrobić używając polecenia <code class="highlighter-rouge">sqlite3 --version</code>.</p>

<h2 id="czym-są-funkcje-analityczne-w-sql">Czym są funkcje analityczne w SQL</h2>

<p>W jednym zdaniu można powiedzieć, że funkcje analityczne (ang. <em>analytic functions</em>) zwracają wartość na podstawie grupy wierszy powiązanych z aktualnym wierszem. Tę grupę nazywa się partycją. Sam opis może być skomplikowany, więc proszę spójrz na przykład poniżej:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="n">invoiceid</span>
        <span class="p">,</span><span class="n">total</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">customer_total_sum</span>
    <span class="k">FROM</span> <span class="n">invoice</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customerid</span>
   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<p>Poza funkcją analityczną użyłem tu <a href="/sortowanie-aliasy-ograniczanie-wynikow-i-zwracanie-unikalnych-wartosci/#aliasy-dla-kolumn">aliasu kolumny</a>, <a href="/sortowanie-aliasy-ograniczanie-wynikow-i-zwracanie-unikalnych-wartosci/#sortowanie-wyników">sortowania</a> i <a href="/sortowanie-aliasy-ograniczanie-wynikow-i-zwracanie-unikalnych-wartosci/#ograniczanie-liczby-wyników">ograniczenia liczby zwracanych wierszy</a>. W wyniku tego zapytania otrzymasz dziesięć wierszy:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CustomerId  InvoiceId  Total  customer_total_sum
----------  ---------  -----  ------------------
1           98         3.98   39.62
1           121        3.96   39.62
1           143        5.94   39.62
1           195        0.99   39.62
1           316        1.98   39.62
1           327        13.86  39.62
1           382        8.91   39.62
2           1          1.98   37.62
2           12         13.86  37.62
2           67         8.91   37.62
</code></pre></div></div>

<p>To zapytanie zwraca cztery różne kolumny. Ostatnia z nich jest wynikiem działania funkcji analitycznej. Spróbuję rozłożyć ją na części pierwsze:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
<span class="n">OVER</span>
<span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span>
</code></pre></div></div>

<p>W pierwszej linijce widzisz funkcję <code class="highlighter-rouge">SUM</code>. Możesz ją pamiętać z <a href="/funkcje-i-grupowanie-wierszy-w-sql/#funkcje-grupujące">artykułu o funkcjach w SQL</a>. W poprzednim przypadku była ona użyta jako funkcja agregująca. Użycie słowa kluczowego <code class="highlighter-rouge">OVER</code> sprawia, że jej zachowanie nieznacznie się zmienia. W tym przypadku <code class="highlighter-rouge">SUM</code> nadal zwraca sumę, jednak w przypadku funkcji analitycznej pod uwagę brana jest partycja a nie cała tabela<sup id="fnref:edgecase" role="doc-noteref"><a href="#fn:edgecase" class="footnote">1</a></sup>.</p>

<p>W ostatniej linijce znajduje się definicja partycji, która zostanie użyta do obliczenia wartości funkcji. W tym przypadku do partycji należą wiersze zawierające taką samą wartość kolumny <code class="highlighter-rouge">customerid</code>.</p>

<p>Zatem ta funkcja:</p>
<ul>
  <li>oblicza sumę kolumny <code class="highlighter-rouge">total</code> (<code class="highlighter-rouge">SUM(total)</code>),</li>
  <li>sumując wiersze, które mają taką samą wartość kolumny <code class="highlighter-rouge">customerid</code> (<code class="highlighter-rouge">PARTITION BY customerid</code>).</li>
</ul>

<p>Proszę spójrz na pierwszych siedem wierszy, które mają taką samą wartość kolumny <code class="highlighter-rouge">customerid</code>. Kolumna <code class="highlighter-rouge">total</code> sumowana jest w ramach partycji: <code class="highlighter-rouge">3.98 + 3.96 + 5.94 + 0.99 + 1.98 + 13.86 + 8.91 = 39.62</code>. Wartość ta, będąca wynikiem działania funkcji, jest przypisywana do każdego wiersza z partycji.</p>

<p>Można powiedzieć, że funkcje analityczne są podobne do standardowego grupowania przy użyciu klauzuli <code class="highlighter-rouge">GROUP BY</code>. Funkcje agregujące zwracają jeden wiersz dla grupy, funkcje analityczne zwracają wiele wierszy.</p>

<h4 id="pozostałe-funkcje-agregujące">Pozostałe funkcje agregujące</h4>

<p>Poniżej znajdziesz listę funkcji agregujących, których możesz użyć przed słowem kluczowym <code class="highlighter-rouge">OVER</code>:</p>

<ul>
  <li><code class="highlighter-rouge">AVG</code> – zwraca średnią wartość,</li>
  <li><code class="highlighter-rouge">COUNT</code> – zwraca liczbę wierszy,</li>
  <li><code class="highlighter-rouge">MAX</code> – zwraca maksymalną wartość,</li>
  <li><code class="highlighter-rouge">MIN</code> – zwraca minimalną wartość,</li>
  <li><code class="highlighter-rouge">SUM</code> – zwraca sumę wartości.</li>
</ul>

<div class="notice--success text-center">
  
<p><span class="c_almost-header">Pobierz opracowania zadań z rozmów kwalifikacyjnych</span></p>

<p>Przygotowałem rozwiązania kilku zadań algorytmicznych z rozmów kwalifikacyjnych. Rozkładam je na czynniki pierwsze i pokazuję różne sposoby ich rozwiązania. Dołącz do grupy <strong>ponad 6147 Samouków</strong>, którzy jako pierwsi dowiadują się o nowych treściach na blogu, a prześlę je na Twój e-mail.</p>

<script type="text/javascript" src="https://static.mailerlite.com/data/webforms/704312/f8q4i2.js?v4"></script>


</div>

<h3 id="klauzula-partition-by">Klauzula <code class="highlighter-rouge">PARTITION BY</code></h3>

<p>W przykładzie wyżej wszystkie wiersze w tabeli <code class="highlighter-rouge">invoice</code> zostały podzielone na osobne partycje. Do podziału na partycje użyłem wyłącznie jednej kolumny. W klauzuli <code class="highlighter-rouge">PARTITION BY</code> możesz użyć wielu wyrażeń:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span>
<span class="n">OVER</span>
<span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">,</span> <span class="n">billingcountry</span><span class="p">)</span>
</code></pre></div></div>

<p>W tym przypadku tabela zostanie podzielona na więcej partycji. Do jednej partycji trafią wszystkie wiersze, które mają taką samą wartość kolumn <code class="highlighter-rouge">customerid</code> i <code class="highlighter-rouge">billingcountry</code>.</p>

<p>Istnieje też możliwość pominięcia klauzuli <code class="highlighter-rouge">PARTITION BY</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">()</span>
</code></pre></div></div>

<p>W takim przypadku partycja równoznaczna jest z całą tabelą<sup id="fnref:virtualtable" role="doc-noteref"><a href="#fn:virtualtable" class="footnote">2</a></sup>. Dla każdego wynikowego wiersza <code class="highlighter-rouge">SUM(total) OVER ()</code> zwróci sumę kolumny <code class="highlighter-rouge">total</code> we wszystkich wierszach.</p>

<h3 id="kiedy-obliczana-jest-wartość-funkcji-analitycznej">Kiedy obliczana jest wartość funkcji analitycznej</h3>

<p>Funkcje analityczne mogą być użyte wyłącznie w klauzuli <code class="highlighter-rouge">SELECT</code> i <code class="highlighter-rouge">ORDER BY</code>. Wynika to z faktu, że funkcje analityczne operują na „wirtualnej tabeli” (w <a href="/wstep-do-relacyjnych-baz-danych/#model-relacyjny">modelu relacyjnym</a> można mówić o relacji), która powstanie po filtrowaniu i grupowaniu wierszy.</p>

<p>Można powiedzieć, że zapytanie wykonywane jest w następującej kolejności:</p>

<ol>
  <li>Wykonanie klauzuli <code class="highlighter-rouge">WHERE</code>,</li>
  <li>Wykonanie klauzuli <code class="highlighter-rouge">GROUP BY</code>,</li>
  <li>Wykonanie klauzuli <code class="highlighter-rouge">HAVING</code>,</li>
  <li>Wykonanie funkcji analitycznych,</li>
  <li>Wykonanie klauzuli <code class="highlighter-rouge">ORDER BY</code>,</li>
  <li>Wykonanie klauzuli <code class="highlighter-rouge">LIMIT</code>.</li>
</ol>

<h3 id="czym-jest-okno">Czym jest okno</h3>

<p>Tak naprawdę, to funkcja do obliczenia wartości bierze pod uwagę tak zwane okno. Każdy wiersz w partycji ma swoje własne okno, które jest podzbiorem partycji. Jeśli okno nie jest zdefiniowane wówczas przyjmuje ono wartość całej partycji. Istnieje wiele możliwości na ograniczenie okna dla funkcji analitycznej. Najprostszym z nich jest użycie klauzuli <code class="highlighter-rouge">ORDER BY</code>.</p>

<h3 id="ćwiczenia-do-samodzielnego-wykonania">Ćwiczenia do samodzielnego wykonania</h3>

<p>Teraz czas na Twoje eksperymenty. Spróbuj samodzielnie uruchomić przykładowe zapytanie. Możesz je także zmodyfikować:</p>

<ul>
  <li>zmień limit zwracanych wierszy,</li>
  <li>zwróć wyłącznie wiersze z parzystą wartością kolumny <code class="highlighter-rouge">customerid</code>.</li>
</ul>

<h2 id="sortowanie-w-funkcjach-analitycznych">Sortowanie w funkcjach analitycznych</h2>

<p>Nieznacznie zmodyfikuję definicję partycji z pierwszego zapytania. Przykład poniżej używa dwóch funkcji. Druga z nich używa <code class="highlighter-rouge">ORDER BY invoiceid</code> po definicji partycji:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="n">invoiceid</span>
        <span class="p">,</span><span class="n">total</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">customer_total_sum</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span>
                              <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">invoiceid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">customer_total_increasing_sum</span>
    <span class="k">FROM</span> <span class="n">invoice</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">,</span> <span class="n">invoiceid</span>
   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<p>Proszę spójrz na wynik zapytania. Zwróć uwagę na wartości kolumn <code class="highlighter-rouge">customer_total_sum</code> i <code class="highlighter-rouge">customer_total_increasing_sum</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CustomerId  InvoiceId  Total  customer_total_sum  customer_total_increasing_sum
----------  ---------  -----  ------------------  -----------------------------
1           98         3.98   39.62               3.98
1           121        3.96   39.62               7.94
1           143        5.94   39.62               13.88
1           195        0.99   39.62               14.87
1           316        1.98   39.62               16.85
1           327        13.86  39.62               30.71
1           382        8.91   39.62               39.62
2           1          1.98   37.62               1.98
2           12         13.86  37.62               15.84
2           67         8.91   37.62               24.75
</code></pre></div></div>

<p>Użycie <code class="highlighter-rouge">ORDER BY</code> w definicji funkcji analitycznej powoduje zmianę okna dla każdego z wierszy. <code class="highlighter-rouge">ORDER BY</code> tworzy „narastające okna” dla każdego kolejnego wiersza:</p>

<ul>
  <li>okno dla pierwszego wiersza to wyłącznie pierwszy wiersz (<code class="highlighter-rouge">3.98 = 3.98</code>),</li>
  <li>okno dla drugiego wiersza to dwa pierwsze wiersze (<code class="highlighter-rouge">3.98 + 3.96 = 7.94</code>),</li>
  <li>okno dla trzeciego wiersza to trzy pierwsze wiersze (<code class="highlighter-rouge">3.98 + 3.96 + 5.94 = 13.88</code>),</li>
  <li>itd.</li>
</ul>

<p>Zauważ, że w tym przykładzie użyłem dwóch klauzul <code class="highlighter-rouge">ORDER BY</code>. Pierwsza z nich służy do określenia okna dla funkcji analitycznej, druga służy do sortowania wyników całego zapytania.</p>

<h3 id="partycje-a-sortowanie">Partycje a sortowanie</h3>

<p>Zapytanie używające partycji zwraca dane posortowane zgodnie z definicją partycji. Na przykład wyniki poniższego zapytania będą posortowane używając kolumny <code class="highlighter-rouge">customerid</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">customerid</span>
      <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">customer_total_sum</span>
  <span class="k">FROM</span> <span class="n">invoice</span>
</code></pre></div></div>

<p>Chociaż dane będą zwrócone w ten sposób nie polegałbym na tym zachowaniu. Jeśli zależy Ci na uzyskaniu posortowanych danych określ to jasno używając <a href="/sortowanie-aliasy-ograniczanie-wynikow-i-zwracanie-unikalnych-wartosci/">klauzuli <code class="highlighter-rouge">ORDER BY</code></a>. W ten sposób jasno określasz swoje intencje:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">customer_total_sum</span>
    <span class="k">FROM</span> <span class="n">invoice</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">;</span>
</code></pre></div></div>

<p>We wszystkich przykładach w artykule dodałem klauzulę <code class="highlighter-rouge">ORDER BY</code>.</p>

<h3 id="ćwiczenia-do-samodzielnego-wykonania-1">Ćwiczenia do samodzielnego wykonania</h3>

<p>Teraz czas na Twoje eksperymenty. Spróbuj samodzielnie uruchomić przykładowe zapytanie zawierające dwie funkcje analityczne. Możesz je także zmodyfikować:</p>

<ul>
  <li>sprawdź jak na wynik zapytania wpływają różne kolumny użyte do sortowania,</li>
  <li>użyj kilku kolumn do sortowania wyników/wierszy w partycji,</li>
  <li>użyj <code class="highlighter-rouge">DESC</code>/<code class="highlighter-rouge">ASC</code> do z zmiany wyniku sortowania.</li>
</ul>

<h2 id="unikanie-duplikacji--nazwane-partycje">Unikanie duplikacji – nazwane partycje</h2>

<p>Wyobraź sobie sytuację, w której chcesz zwrócić wynik różnych funkcji analitycznych, jednak używając tej samej definicji partycji. Spójrz na przykład poniżej:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="n">invoiceid</span>
        <span class="p">,</span><span class="n">total</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">customer_total_sum</span>
        <span class="p">,</span><span class="k">AVG</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">customer_total_avg</span>
    <span class="k">FROM</span> <span class="n">invoice</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customerid</span>
   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<p>W tym przykładzie definicja partycji jest prosta. Możesz jednak trafić na przypadek, w którym będzie ona dużo bardziej skomplikowana. Takie zapytanie zawiera duplikację definicji partycji. Duplikacja w większości przypadków jest zła. Nie inaczej jest w przypadku zapytań SQL. W takiej sytuacji z pomocą przychodzi klauzula <code class="highlighter-rouge">WINDOW</code>. Proszę spójrz na przykład poniżej, jest on równoznaczny z poprzednim zapytaniem:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="n">invoiceid</span>
        <span class="p">,</span><span class="n">total</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">customer_window</span> <span class="k">AS</span> <span class="n">customer_total_sum</span>
        <span class="p">,</span><span class="k">AVG</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">customer_window</span> <span class="k">AS</span> <span class="n">customer_total_avg</span>
    <span class="k">FROM</span> <span class="n">invoice</span>
  <span class="n">WINDOW</span> <span class="n">customer_window</span> <span class="k">AS</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customer</span> <span class="n">id</span>
   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<p>Oba zapytania zwrócą ten sam wynik:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CustomerId  InvoiceId  Total  customer_total_sum  customer_total_avg
----------  ---------  -----  ------------------  ------------------
1           98         3.98   39.62               5.66
1           121        3.96   39.62               5.66
1           143        5.94   39.62               5.66
1           195        0.99   39.62               5.66
1           316        1.98   39.62               5.66
1           327        13.86  39.62               5.66
1           382        8.91   39.62               5.66
2           1          1.98   37.62               5.37428571428571
2           12         13.86  37.62               5.37428571428571
2           67         8.91   37.62               5.37428571428571
</code></pre></div></div>

<p>Co więcej partycje zdefiniowane w ten sposób możesz dodatkowo rozszerzać:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="n">invoiceid</span>
        <span class="p">,</span><span class="n">total</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">customer_window</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">invoiceid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">customer_ordered_total_sum</span>
        <span class="p">,</span><span class="k">AVG</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">customer_window</span> <span class="k">AS</span> <span class="n">customer_total_avg</span>
    <span class="k">FROM</span> <span class="n">invoice</span>
  <span class="n">WINDOW</span> <span class="n">customer_window</span> <span class="k">AS</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customerid</span>
   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<p>W tym przykładzie suma kolumny <code class="highlighter-rouge">total</code> jest narastająca:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CustomerId  InvoiceId  Total  customer_ordered_total_sum  customer_total_avg
----------  ---------  -----  --------------------------  ------------------
1           98         3.98   3.98                        5.66
1           121        3.96   7.94                        5.66
1           143        5.94   13.88                       5.66
1           195        0.99   14.87                       5.66
1           316        1.98   16.85                       5.66
1           327        13.86  30.71                       5.66
1           382        8.91   39.62                       5.66
2           1          1.98   1.98                        5.37428571428571
2           12         13.86  15.84                       5.37428571428571
2           67         8.91   24.75                       5.37428571428571
</code></pre></div></div>

<h2 id="funkcje-okna">Funkcje okna</h2>

<p>Jak już wiesz funkcje analityczne działają w oparciu o partycje. Dodatkowo funkcje te pozwalają Ci na zdefiniowanie tak zwanego okna. Domyślnie okno zawiera:</p>

<ul>
  <li>wszystkie wiersze partycji jeśli nie użyjesz klauzuli <code class="highlighter-rouge">ORDER BY</code>,</li>
  <li>wiersze „do aktualnego wiersza” jeśli użyjesz klauzuli <code class="highlighter-rouge">ORDER BY</code>.</li>
</ul>

<p>Domyślną zawartość okna możesz zmienić. Okno pozwala na dalsze ograniczenie wierszy branych pod uwagę przez funkcję. Składnię można rozszerzyć do:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">funkcja</span><span class="o">&gt;</span>
<span class="n">OVER</span>
<span class="p">[</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="err">…</span> <span class="p">]</span>
<span class="p">[</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="err">…</span> <span class="p">]</span>
<span class="o">&lt;</span><span class="n">definicja</span> <span class="n">okna</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Okno może być jednego z trzech rodzajów:</p>

<ul>
  <li><code class="highlighter-rouge">ROWS</code> – granice okna określone są przez liczbę wierszy przed i po aktualnym wierszu,</li>
  <li><code class="highlighter-rouge">GROUPS</code> – granice okna określone są przez liczbę „grup” przed i po aktualnej „grupie”. Do grupy zalicza się te wartości, które są „równe” w trakcie sortowania przy użyciu <code class="highlighter-rouge">ORDER BY</code>,</li>
  <li><code class="highlighter-rouge">RANGE</code> – granice okna określone są przez różnicę wartości względem aktualnego wiersza.</li>
</ul>

<p>Dla uproszczenia w definicji okna będę używał wyłącznie <code class="highlighter-rouge">BETWEEN x PRECEDING AND y FOLLOWING</code>. Oznacza to, że okno będzie obejmowało zakres <code class="highlighter-rouge">x</code> przed aktualnym wierszem i <code class="highlighter-rouge">y</code> po aktualnym wierszu. Składania pozwala na dużo bardziej zaawansowane modyfikacje, jednak ich znajomość nie jest niezbędna do zrozumienia działania samego mechanizmu. Jeśli jesteś zainteresowany tymi szczegółami odsyłam Cię do dokumentacji silnika bazy danych, którego używasz.</p>

<p>Mam świadomość, że to wszystko brzmi jak łacina bez konkretnego przykładu. Postaram się to poprawić ;)</p>

<h3 id="okno-typu-rows">Okno typu <code class="highlighter-rouge">ROWS</code></h3>

<p>Proszę spójrz na pierwszy z nich:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="n">invoiceid</span>
        <span class="p">,</span><span class="n">total</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span>
                              <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">invoiceid</span>
                                  <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">1</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">1</span> <span class="n">FOLLOWING</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rolling_sum</span>
    <span class="k">FROM</span> <span class="n">invoice</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="n">invoiceid</span>
   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<p>W wyniku tego zapytania otrzymasz 10 wierszy:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CustomerId  InvoiceId  Total  rolling_sum
----------  ---------  -----  -----------
1           98         3.98   7.94
1           121        3.96   13.88
1           143        5.94   10.89
1           195        0.99   8.91
1           316        1.98   16.83
1           327        13.86  24.75
1           382        8.91   22.77
2           1          1.98   15.84
2           12         13.86  24.75
2           67         8.91   24.75
</code></pre></div></div>

<p>W tym przypadku <code class="highlighter-rouge">SUM(total)</code> sumuje jedynie wiersze należące do okna, a nie całej partycji.</p>

<ul>
  <li>dla pierwszego wiersza oknem są wiersze pierwszy i drugi: <code class="highlighter-rouge">3.98 + 3.96 = 7.94</code> (brak poprzedniego wiersza w partycji),</li>
  <li>dla drugiego wiersza oknem są wiersze pierwszy, drugi i trzeci: <code class="highlighter-rouge">3.98 + 3.96 + 5.94 = 13.88</code> ,</li>
  <li>dla siódmego wiersza oknem są wiersze szósty i siódmy: <code class="highlighter-rouge">13.86 + 8.91 = 22.77</code> (brak następnego wiersza w partycji).</li>
</ul>

<h3 id="okno-typu-groups">Okno typu <code class="highlighter-rouge">GROUPS</code></h3>

<p>Tym razem do utworzenia partycji posłużę się kolumną <code class="highlighter-rouge">billingcountry</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="n">billingcountry</span>
        <span class="p">,</span><span class="n">invoiceid</span>
        <span class="p">,</span><span class="n">total</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">billingcountry</span>
                              <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">total</span>
                                <span class="n">GROUPS</span> <span class="k">BETWEEN</span> <span class="mi">1</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">1</span> <span class="n">FOLLOWING</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rolling_sum</span>
    <span class="k">FROM</span> <span class="n">invoice</span>
   <span class="k">WHERE</span> <span class="n">billingcountry</span> <span class="o">=</span> <span class="s1">'India'</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">total</span><span class="p">;</span>
</code></pre></div></div>

<p>W wyniku tego zapytania otrzymasz 13 wierszy:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BillingCountry  InvoiceId  Total  rolling_sum
--------------  ---------  -----  -----------
India           120        1.98   9.92
India           218        1.98   9.92
India           315        1.98   9.92
India           97         1.99   17.84
India           412        1.99   17.84
India           23         3.96   23.78
India           338        3.96   23.78
India           45         5.94   37.62
India           360        5.94   37.62
India           186        8.91   57.42
India           284        8.91   57.42
India           131        13.86  45.54
India           229        13.86  45.54
</code></pre></div></div>

<p>Także tym przypadku <code class="highlighter-rouge">SUM(total)</code> sumuje jedynie wiersze należące do okna, a nie całej partycji:</p>

<ul>
  <li>dla pierwszego wiersza oknem jest pierwszych pięć wierszy. Grupa do której należy pierwszy wiersz i następna grupa: <code class="highlighter-rouge">3 * 1.98 + 2 * 1.99 = 9.92</code> (brak poprzedniej grupy w partycji),</li>
  <li>dla piątego wiersza oknem jest pierwszych siedem wierszy. Grupa poprzedzająca, grupa do której należy piąty wiersz i następna grupa: <code class="highlighter-rouge">3 * 1.98 + 2 * 1.99 + 2 * 3.96 = 17.84</code> ,</li>
  <li>dla przedostatniego wiersza oknem są wiersze 10., 11., 12. i 13.: <code class="highlighter-rouge">2 * 8.91 + 2 * 13.86</code> (brak następnej grupy w partycji).</li>
</ul>

<h3 id="okno-typu-range">Okno typu <code class="highlighter-rouge">RANGE</code></h3>

<p>W tym przypadku okno definiowane jest jako „odległość” 2 przed i po wartości kolumny <code class="highlighter-rouge">total</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="n">invoiceid</span>
        <span class="p">,</span><span class="n">total</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span>
                              <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">total</span>
                                 <span class="n">RANGE</span> <span class="k">BETWEEN</span> <span class="mi">2</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">2</span> <span class="n">FOLLOWING</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rolling_sum</span>
    <span class="k">FROM</span> <span class="n">invoice</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="n">total</span>
   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<p>W wyniku tego zapytania otrzymasz dziesięć wierszy:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CustomerId  InvoiceId  Total  rolling_sum
----------  ---------  -----  -----------
1           195        0.99   2.97
1           316        1.98   10.91
1           121        3.96   15.86
1           98         3.98   15.86
1           143        5.94   13.88
1           382        8.91   8.91
1           327        13.86  13.86
2           293        0.99   4.95
2           1          1.98   8.91
2           196        1.98   8.91
</code></pre></div></div>

<p>Także tutaj <code class="highlighter-rouge">SUM(total)</code> sumuje jedynie wiersze należące do okna, a nie całej partycji.</p>

<ul>
  <li>dla pierwszego wiersza oknem są pierwsze dwa wiersze. Dzieje się tak ponieważ wartość kolumny <code class="highlighter-rouge">total</code> dla tych wierszy jest w zakresie  <code class="highlighter-rouge">&lt;0.99 - 2, 0.99 + 2&gt;</code>,</li>
  <li>dla drugiego wiersza oknem są pierwsze cztery wiersze. Dzieje się tak ponieważ wartość kolumny <code class="highlighter-rouge">total</code> dla tych wierszy jest w zakresie  <code class="highlighter-rouge">&lt;1.98 - 2, 1.98 + 2&gt;</code>,</li>
  <li>dla trzeciego wiersza oknem są wiersze drugi, trzeci, czwarty i piąty. Dzieje się tak ponieważ wartość kolumny <code class="highlighter-rouge">total</code> dla tych wierszy jest w zakresie  <code class="highlighter-rouge">&lt;3.96 - 2, 3.96 + 2&gt;</code>.</li>
</ul>

<h3 id="filtrowanie-okna">Filtrowanie okna</h3>

<p>Jakby tego było mało do tego wszystkiego dochodzi możliwość filtrowania :). Oznacza to tyle, że możesz użyć filtrowania jak w klauzuli <code class="highlighter-rouge">WHERE</code>, żeby dodatkowo ograniczyć wiersze „pasujące” do definicji okna. Proszę spójrz na przykład poniżej:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="n">invoiceid</span>
        <span class="p">,</span><span class="n">total</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">rows_window</span> <span class="k">AS</span> <span class="n">rolling_sum</span>
        <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">FILTER</span> <span class="p">(</span><span class="k">WHERE</span> <span class="n">invoiceid</span> <span class="o">!=</span> <span class="mi">121</span><span class="p">)</span>
                      <span class="n">OVER</span> <span class="n">rows_window</span> <span class="k">AS</span> <span class="n">filtered_rolling_sum</span>
    <span class="k">FROM</span> <span class="n">invoice</span>
  <span class="n">WINDOW</span> <span class="n">rows_window</span> <span class="k">AS</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customerid</span>
   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<p>Zwróć uwagę na wartości kolumn <code class="highlighter-rouge">rolling_sum</code> i <code class="highlighter-rouge">filtered_rolling_sum</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CustomerId  InvoiceId  Total  rolling_sum  filtered_rolling_sum
----------  ---------  -----  -----------  --------------------
1           98         3.98   39.62        35.66
1           121        3.96   39.62        35.66
1           143        5.94   39.62        35.66
1           195        0.99   39.62        35.66
1           316        1.98   39.62        35.66
1           327        13.86  39.62        35.66
1           382        8.91   39.62        35.66
2           1          1.98   37.62        37.62
2           12         13.86  37.62        37.62
2           67         8.91   37.62        37.62
</code></pre></div></div>

<p><code class="highlighter-rouge">filtered_rolling_sum</code> ma wartość <code class="highlighter-rouge">39.62 - 3.96 = 35.66</code>. Zatem funkcja analityczna w przypadku partycji gdzie <code class="highlighter-rouge">customerid = 1</code> nie wzięła pod uwagę filtrowanego wiersza. Wiersz, w którym <code class="highlighter-rouge">invoiceid = 121</code> nie został wzięty pod uwagę podczas sumowania. Dla przypomnienia odsyłam cię do artykułu opisującego <a href="/klauzula-where-w-zapytaniach-sql/">klauzulę <code class="highlighter-rouge">WHERE</code></a>.</p>

<h3 id="lista-funkcji">Lista funkcji</h3>

<p>Bazy danych posiadają szereg funkcji dedykowanych do użycia z klauzulą <code class="highlighter-rouge">OVER</code>. Poniżej znajdziesz listę zawierającą część z nich. Podobnie jak w innych przypadkach odsyłam Cię do dokumentacji Twojej bazy danych, jeśli chcesz znać ich komplet:</p>

<ul>
  <li><code class="highlighter-rouge">ROW_NUMBER()</code> – Numeruje wiersze w partycji zaczynając od 1. Bierze pod uwagę klauzulę <code class="highlighter-rouge">ORDER BY</code>,</li>
  <li><code class="highlighter-rouge">RANK()</code>, <code class="highlighter-rouge">DENSE_RANK()</code> – Funkcje numerujące unikalne wartości w partycji. <code class="highlighter-rouge">RANK</code> zostawia „dziury” w numeracji. Pokażę to na przykładzie poniżej. Bez klauzuli <code class="highlighter-rouge">ORDER BY</code> każdy z wierszy ma numer 1,</li>
  <li><code class="highlighter-rouge">NTILE(N)</code> – Dzieli partycję na <code class="highlighter-rouge">N</code> „możliwie równych” i przydziela wiersze do grup o wartości od 1 do <code class="highlighter-rouge">N</code>.</li>
</ul>

<p>Pierwszy przykład pokazuje działanie funkcji <code class="highlighter-rouge">ROW_NUMBER</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">customerid</span>
      <span class="p">,</span><span class="n">total</span>
      <span class="p">,</span><span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">row_number</span>
  <span class="k">FROM</span> <span class="n">invoice</span>
 <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CustomerId  Total  row_number
----------  -----  ----------
1           0.99   1
1           1.98   2
1           3.96   3
1           3.98   4
1           5.94   5
1           8.91   6
1           13.86  7
2           0.99   1
2           1.98   2
2           1.98   3
</code></pre></div></div>

<p>Drugi przykład porównuje funkcje <code class="highlighter-rouge">RANK</code> i <code class="highlighter-rouge">DENSE_RANK</code>. Proszę zwróć uwagę na wyniki tych funkcji dla 10. i 11. wiersza:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">customerid</span>
      <span class="p">,</span><span class="n">total</span>
      <span class="p">,</span><span class="n">RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="n">customer_window</span> <span class="k">AS</span> <span class="n">rank_unsorted</span>
      <span class="p">,</span><span class="n">DENSE_RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="n">customer_window</span> <span class="k">AS</span> <span class="n">dense_rank_unsorted</span>
      <span class="p">,</span><span class="n">RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">customer_window</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rank_sorted</span>
      <span class="p">,</span><span class="n">DENSE_RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">customer_window</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">total</span><span class="p">)</span> <span class="k">AS</span> <span class="n">dense_rank_sorted</span>
  <span class="k">FROM</span> <span class="n">invoice</span>
<span class="n">WINDOW</span> <span class="n">customer_window</span> <span class="k">AS</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span>
 <span class="k">LIMIT</span> <span class="mi">13</span><span class="p">;</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CustomerId  Total  rank_unsorted  dense_rank_unsorted  rank_sorted  dense_rank_sorted
----------  -----  -------------  -------------------  -----------  -----------------
1           0.99   1              1                    1            1
1           1.98   1              1                    2            2
1           3.96   1              1                    3            3
1           3.98   1              1                    4            4
1           5.94   1              1                    5            5
1           8.91   1              1                    6            6
1           13.86  1              1                    7            7
2           0.99   1              1                    1            1
2           1.98   1              1                    2            2
2           1.98   1              1                    2            2
2           3.96   1              1                    4            3
2           5.94   1              1                    5            4
2           8.91   1              1                    6            5
</code></pre></div></div>

<p>Ostatni przykład pokazuje sposób podziału partycji przez funkcję <code class="highlighter-rouge">NTILE</code> z użyciem różnych argumentów:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">customerid</span>
      <span class="p">,</span><span class="n">total</span>
      <span class="p">,</span><span class="n">NTILE</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">customer_window</span> <span class="k">AS</span> <span class="n">ntile_2</span>
      <span class="p">,</span><span class="n">NTILE</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">customer_window</span> <span class="k">AS</span> <span class="n">ntile_4</span>
  <span class="k">FROM</span> <span class="n">invoice</span>
<span class="n">WINDOW</span> <span class="n">customer_window</span> <span class="k">AS</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span><span class="p">)</span>
 <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CustomerId  Total  ntile_2  ntile_4
----------  -----  -------  -------
1           3.98   1        1
1           3.96   1        1
1           5.94   1        2
1           0.99   1        2
1           1.98   2        3
1           13.86  2        3
1           8.91   2        4
2           1.98   1        1
2           13.86  1        1
2           8.91   1        2
</code></pre></div></div>

<h2 id="funkcje-analityczne-a-klauzula-where">Funkcje analityczne a klauzula <code class="highlighter-rouge">WHERE</code></h2>

<p>Jak już wiesz funkcje analityczne mogą być użyte wyłącznie w klauzuli <code class="highlighter-rouge">SELECT</code> i <code class="highlighter-rouge">ORDER BY</code>. Co jeśli musisz użyć wyniku funkcji analitycznej do filtrowania? Z pomocą przychodzą <a href="/podzapytania-sql/">podzapytania</a>. Na przykład poniższe zapytanie zwróci wyłącznie te faktury wystawione dla klienta, których suma będzie mniejsza niż 10:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="n">customerid</span>
        <span class="p">,</span><span class="n">invoiceid</span>
        <span class="p">,</span><span class="n">total</span>
    <span class="k">FROM</span> <span class="n">invoice</span> <span class="k">JOIN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">invoiceid</span>
                             <span class="p">,</span><span class="k">SUM</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customerid</span>
                                                   <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">invoiceid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">invoice_sum</span>
                         <span class="k">FROM</span> <span class="n">invoice</span><span class="p">)</span>
                 <span class="k">USING</span> <span class="p">(</span><span class="n">invoiceid</span><span class="p">)</span>
   <span class="k">WHERE</span> <span class="n">invoice_sum</span> <span class="o">&lt;</span> <span class="mi">10</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customerid</span>
   <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CustomerId  InvoiceId  Total
----------  ---------  -----
1           98         3.98
1           121        3.96
2           1          1.98
3           99         3.98
4           2          3.96
4           24         5.94
5           77         1.98
5           100        3.96
6           46         8.91
7           78         1.98
</code></pre></div></div>

<p class="notice--info">Nie przejmuj się, jeśli to zapytanie będzie dla Ciebie zbyt skomplikowane. To nic dziwnego, używa ono wielu elementów składki SQL. Postaraj się przeanalizować je jeszcze raz. Spróbuj też samodzielnie eksperymentować. Zacznij od wywołania podzapytania i przeanalizowania jego wyników.</p>

<h2 id="dodatkowe-materiały-do-nauki">Dodatkowe materiały do nauki</h2>

<p>Artykuł nie wyczerpuje tematu funkcji analitycznych. Zachęcam Cię do rzucenia okiem na dodatkowe materiały do nauki. Pamiętaj, że dokumentacja Twojego silnika baz danych jest niezastąpiona ;) i zawiera dużo bardziej szczegółowe informacje.</p>

<ul>
  <li><a href="https://www.postgresql.org/docs/current/tutorial-window.html">Tutorial dotyczący funkcji analitycznych dla PostgreSQL</a>,</li>
  <li><a href="https://www.postgresql.org/docs/current/sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS">Składnia funkcji analitycznych w PostgreSQL</a>,</li>
  <li><a href="https://www.postgresql.org/docs/current/functions-window.html">Funkcje okna w PostgreSQL</a>,</li>
  <li><a href="https://www.sqlite.org/windowfunctions.html">Składnia funkcji analitycznych w SQLite</a>,</li>
  <li><a href="http://tpd.cs.put.poznan.pl/accounts/pdf/PABD/SQL_ZaawansowaneAnalizy_Czesc2_Wyklad.pdf">Materiały wykładowe z Politechniki Poznańskiej</a>.</li>
</ul>

<h2 id="podsumowanie">Podsumowanie</h2>

<p>Po przeczytaniu tego artykułu wiesz już czym są funkcje analityczne. Wiesz czym takie funkcje różnią się od zwykłego grupowania. Wiesz czym są funkcje okna i jak ich używać. Po przerobieniu ćwiczeń możesz śmiało powiedzieć, że udało Ci się sprawdzić wiedzę w praktyce. Gratulacje ;), funkcje analityczne to jedne z bardziej zaawansowanych elementów składki SQL.</p>

<p>Mam nadzieję, że artykuł był dla Ciebie pomocny. Proszę podziel się nim ze swoimi znajomymi. Dzięki temu pozwolisz mi dotrzeć do nowych Czytelników, za co z góry dziękuję. Jeśli nie chcesz pominąć kolejnych artykułów dopisz się do samouczkowego newslettera i polub <a href="https://www.facebook.com/SamouczekProgramisty">Samouczka Programisty na Facebooku</a>.</p>

<p>Do następnego razu!</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:edgecase" role="doc-endnote">
      <p>W wyjątkowych przypadkach partycją może być także cała tabela. Przeczytasz o tym w dalszej części artykułu. <a href="#fnref:edgecase" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:virtualtable" role="doc-endnote">
      <p>Właściwie to nie z całą tabelą, a relacją powstałą po filtrowaniu i grupowaniu. Także to zagadnienie opiszę dokładniej w dalszej części artykułu. <a href="#fnref:virtualtable" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

        

<div class="notice--success text-center">
  
<p><span class="c_almost-header">Pobierz opracowania zadań z rozmów kwalifikacyjnych</span></p>

<p>Przygotowałem rozwiązania kilku zadań algorytmicznych z rozmów kwalifikacyjnych. Rozkładam je na czynniki pierwsze i pokazuję różne sposoby ich rozwiązania. Dołącz do grupy <strong>ponad 6147 Samouków</strong>, którzy jako pierwsi dowiadują się o nowych treściach na blogu, a prześlę je na Twój e-mail.</p>

<script type="text/javascript" src="https://static.mailerlite.com/data/webforms/698960/m0b4d5.js?v4"></script>


</div>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Kategorie: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/kategorie/#bazy-danych" class="page__taxonomy-item" rel="tag">Bazy danych</a><span class="sep">, </span>
    
      
      
      <a href="/kategorie/#kurs-sql" class="page__taxonomy-item" rel="tag">Kurs SQL</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Ostatnia aktualizacja:</strong> <time datetime="2021-05-04">2021-05-04</time></p>
        
        <p><strong><i class="fas fa-fw fa-child" aria-hidden="true"></i> Autor: </strong><a href="/o-mnie/">Marcin Pietraszek</a></p>
        <hr />
        <p>
          Nie popełnia błędów tylko ten, kto nic nie robi ;). Bardzo możliwe, że znajdziesz błąd, literówkę, coś co wymaga poprawy. Jeśli chcesz możesz samodzielnie 
          <a href="https://github.com/SamouczekProgramisty/samouczekprogramisty.github.io/edit/source/_posts/2021-05-04-funkcje-analityczne-w-sql.md">poprawić tę stronę</a>. Jeśli nie chcesz poprawiać błędu, który udało Ci się znaleźć będę wdzięczny jeśli go 
          <a href="https://github.com/SamouczekProgramisty/samouczekprogramisty.github.io/issues/new?title=Błąd%20na%20stronie:%20_posts/2021-05-04-funkcje-analityczne-w-sql.md">zgłosisz</a>. Z góry dziękuję!
        </p>
      </footer>
    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Zostaw komentarz</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">Także może Ci się spodobać</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2019/08/19_podzapytania_sql_artykul.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/podzapytania-sql/" rel="permalink">Podzapytania SQL
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  12 minut(y)

</p>
    
    <p class="archive__item-excerpt" itemprop="description">W tym artykule opisuję podzapytania SQL. Po lekturze tego artykułu będziesz wiedzieć czym są podzapytania, kiedy można je stosować i w jakich miejscach mogą ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2018/10/20_funkcje_i_grupowanie_wierszy_w_sql.jpeg" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/funkcje-i-grupowanie-wierszy-w-sql/" rel="permalink">Funkcje i grupowanie wierszy w SQL
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minut(y)

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Artykuł ten opisuje podstawowe funkcje używane w zapytaniach SQL. Omawia także mechanizm grupowania. Po lekturze tego artykułu będziesz wiedzieć jak używać k...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2018/09/04_sortowanie_aliasy_distinct_sql.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/sortowanie-aliasy-ograniczanie-wynikow-i-zwracanie-unikalnych-wartosci/" rel="permalink">Sortowanie, aliasy, ograniczanie wyników i zwracanie unikalnych wartości
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  9 minut(y)

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Artykuł ten opisuje kilka wyrażeń używanych w SQL. Po lekturze będziesz wiedzieć jak używać i do czego służą DISTINCT, AS czy UNION. Poznasz także sposoby na...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2018/06/28_pobieranie_danych_z_bazy_select_artykul.jpeg" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/pobieranie-danych-z-bazy-select/" rel="permalink">Pobieranie danych z bazy – SELECT
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  13 minut(y)

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Jest to pierwszy artykuł w praktycznym kursie SQL dla początkujących. Po przeczytaniu tego artykułu będziesz wiedzieć czym jest język SQL. Dowiesz się jak wy...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><div class="search-searchbar"></div>
  <div class="search-hits"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">

    
      <li><strong>Śledź:</strong></li>
    

    
      
        
          <li><a href="https://www.facebook.com/SamouczekProgramisty" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i> Facebook</a></li>
        
      
        
          <li><a href="https://github.com/SamouczekProgramisty" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.youtube.com/channel/UCisPQ5nxB6yw3SfJPFWKTEg" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i> YouTube</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>

  <ul>
    <li><a href="https://www.samouczekprogramisty.pl/o-mnie/">O mnie</a></li>
    <li><a href="https://www.samouczekprogramisty.pl/o-blogu/">O blogu</a></li>
    <li><a href="https://www.samouczekprogramisty.pl/polityka-prywatnosci/">Polityka prywatności</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2015-2022 Marcin Pietraszek</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>


<!-- Including InstantSearch.js library and styling -->
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3.3/dist/instantsearch.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3.3/dist/instantsearch.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3.3/dist/instantsearch-theme-algolia.min.css">

<script>
// Instanciating InstantSearch.js with Algolia credentials
const search = instantsearch({
  appId: 'BAIWADE3K7',
  apiKey: '4a78df6a4d9f820ebbdb0a35f834b174',
  indexName: 'prod_samouczek',
  searchParameters: {
    restrictSearchableAttributes: [
      'title',
      'content'
    ]
  }
});

const hitTemplate = function(hit) {
  const url = hit.url;
  const title = hit._highlightResult.title.value;
  const content = hit._highlightResult.html.value;

  return `
    <div class="list__item">
      <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
        <h2 class="archive__item-title" itemprop="headline"><a href="${url}">${title}</a></h2>
        <div class="archive__item-excerpt" itemprop="description">${content}</div>
      </article>
    </div>
  `;
}

// Adding searchbar and results widgets
search.addWidget(
  instantsearch.widgets.searchBox({
    container: '.search-searchbar',
    poweredBy: true,
    placeholder: 'Szukaj...'
  })
);
search.addWidget(
  instantsearch.widgets.hits({
    container: '.search-hits',
    templates: {
      item: hitTemplate,
      empty: 'Brak wyników',
    }
  })
);

// Starting the search only when toggle is clicked
$(document).ready(function () {
  $(".search__toggle").on("click", function() {
    if(!search.started) {
      search.start();
    }
  });
});
</script>





  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-68536783-1']);
  
    _gaq.push(['_gat._anonymizeIp']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "https://www.samouczekprogramisty.pl/funkcje-analityczne-w-sql/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = ""; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://samouczekprogramisty.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Proszę włacz obsługę JavaScript żeby móc zobaczyć komentarze.</noscript>


  





  </body>
</html>
