<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="pl" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Wątki w języku Java - Samouczek Programisty</title>
<meta name="description" content="Artykuł ten opisuje wątki w języku Java. Po jego lekturze dowiesz się czym jest wątek, jaki ma cykl życia i jak go uruchomić. Dowiesz się czym jest synchronizacja i poznasz jej podstawowe mechanizmy. Dowiesz się też jakie mogą być konsekwencje jej braku. Poznasz dwa słowa kluczowe i fragment biblioteki standardowej pomagającej w pisaniu wielowątkowego kodu. Po lekturze tego artykułu będziesz wiedzieć co oznacza wyścig w kontekście programowania wielowątkowego. Na końcu artykułu czekają na Ciebie zadania, w których przećwiczysz zdobytą wiedzę.">


  <meta name="author" content="Marcin Pietraszek">
  
  <meta property="article:author" content="Marcin Pietraszek">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="pl">
<meta property="og:site_name" content="Samouczek Programisty">
<meta property="og:title" content="Wątki w języku Java">
<meta property="og:url" content="https://www.samouczekprogramisty.pl/watki-w-jezyku-java/">


  <meta property="og:description" content="Artykuł ten opisuje wątki w języku Java. Po jego lekturze dowiesz się czym jest wątek, jaki ma cykl życia i jak go uruchomić. Dowiesz się czym jest synchronizacja i poznasz jej podstawowe mechanizmy. Dowiesz się też jakie mogą być konsekwencje jej braku. Poznasz dwa słowa kluczowe i fragment biblioteki standardowej pomagającej w pisaniu wielowątkowego kodu. Po lekturze tego artykułu będziesz wiedzieć co oznacza wyścig w kontekście programowania wielowątkowego. Na końcu artykułu czekają na Ciebie zadania, w których przećwiczysz zdobytą wiedzę.">



  <meta property="og:image" content="https://www.samouczekprogramisty.pl/assets/images/2019/02/02_watki_w_jezyku_java_artykul.jpg">





  <meta property="article:published_time" content="2019-02-11T00:00:00+01:00">



  <meta property="article:modified_time" content="2019-08-27T22:21:16+02:00">



  

  


<link rel="canonical" href="https://www.samouczekprogramisty.pl/watki-w-jezyku-java/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Marcin Pietraszek",
      "url": "https://www.samouczekprogramisty.pl/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Samouczek Programisty Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <link rel="shortcut icon" href="/assets/images/favicon.ico" /> 
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo.gif" alt="Samouczek Programisty"></a>
        
        <a class="site-title" href="/">
          Samouczek Programisty
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/kurs-programowania-java/">Kurs programowania Java</a>
            </li><li class="masthead__menu-item">
              <a href="/kurs-aplikacji-webowych/">Kurs aplikacji webowych</a>
            </li><li class="masthead__menu-item">
              <a href="/kurs-sql/">Kurs SQL</a>
            </li><li class="masthead__menu-item">
              <a href="/kontakt/">Kontakt</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Przełącz menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('/assets/images/2019/02/02_watki_w_jezyku_java_artykul.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Wątki w języku Java

        
      </h1>
      
        <p class="page__lead">Artykuł ten opisuje wątki w języku Java. Po jego lekturze dowiesz się czym jest wątek, jaki ma cykl życia i jak go uruchomić. Dowiesz się czym jest synchronizacja i poznasz jej podstawowe mechanizmy. Dowiesz się też jakie mogą być konsekwencje jej braku. Poznasz dwa słowa kluczowe i fragment biblioteki standardowej pomagającej w pisaniu wielowątkowego kodu. Po lekturze tego artykułu będziesz wiedzieć co oznacza wyścig w kontekście programowania wielowątkowego. Na końcu artykułu czekają na Ciebie zadania, w których przećwiczysz zdobytą wiedzę.
</p>
      
      

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          22 minut(y)
        
      </span>
    
  </p>


      
      
    </div>
  
  
    <span class="page__hero-caption"><a href="https://unsplash.com/photos/87hFrPk3V-s">© Héctor J. Rivas</a>
</span>
  
</div>




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://www.samouczekprogramisty.pl/" itemprop="item"><span itemprop="name">Strona główna</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Wątki w języku Java</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">

  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Wątki w języku Java">
    <meta itemprop="description" content="Artykuł ten opisuje wątki w języku Java. Po jego lekturze dowiesz się czym jest wątek, jaki ma cykl życia i jak go uruchomić. Dowiesz się czym jest synchronizacja i poznasz jej podstawowe mechanizmy. Dowiesz się też jakie mogą być konsekwencje jej braku. Poznasz dwa słowa kluczowe i fragment biblioteki standardowej pomagającej w pisaniu wielowątkowego kodu. Po lekturze tego artykułu będziesz wiedzieć co oznacza wyścig w kontekście programowania wielowątkowego. Na końcu artykułu czekają na Ciebie zadania, w których przećwiczysz zdobytą wiedzę.">
    <meta itemprop="datePublished" content="February 11, 2019">
    <meta itemprop="dateModified" content="August 27, 2019">

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        <aside class="sidebar__right ">
          
          <nav class="toc">
            <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Spis treści</h4></header>
            <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#stwórz-swój-pierwszy-wątek">Stwórz swój pierwszy wątek</a></li>
<li class="toc-entry toc-h2"><a href="#wątki-w-teorii">Wątki w teorii</a>
<ul>
<li class="toc-entry toc-h3"><a href="#program-bez-wątków">Program bez wątków</a></li>
<li class="toc-entry toc-h3"><a href="#program-wielowątkowy">Program wielowątkowy</a>
<ul>
<li class="toc-entry toc-h4"><a href="#szatkowanie-czasu-">Szatkowanie czasu :)</a></li>
<li class="toc-entry toc-h4"><a href="#procesory-wielordzeniowe">Procesory wielordzeniowe</a></li>
<li class="toc-entry toc-h4"><a href="#połączenie-obu-podejść">Połączenie obu podejść</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#wspólne-dane">Wspólne dane</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#tworzenie-nowego-wątku">Tworzenie nowego wątku</a>
<ul>
<li class="toc-entry toc-h3"><a href="#dziedziczenie-po-klasie-thread">Dziedziczenie po klasie Thread</a></li>
<li class="toc-entry toc-h3"><a href="#implementacja-interfejsu-runnable">Implementacja interfejsu Runnable</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#cykl-życia-wątku">Cykl życia wątku</a></li>
<li class="toc-entry toc-h2"><a href="#omówienie-przykładu">Omówienie przykładu</a></li>
<li class="toc-entry toc-h2"><a href="#wątek-w-stanie-blocked">Wątek w stanie BLOCKED</a>
<ul>
<li class="toc-entry toc-h3"><a href="#dlaczego-synchronizacja-jest-potrzebna">Dlaczego synchronizacja jest potrzebna?</a></li>
<li class="toc-entry toc-h3"><a href="#wyścig">Wyścig</a>
<ul>
<li class="toc-entry toc-h4"><a href="#przykład-zachowania-wątków">Przykład zachowania wątków</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#synchronizacja-wątków">Synchronizacja wątków</a>
<ul>
<li class="toc-entry toc-h4"><a href="#blok-synchronized">Blok synchronized</a></li>
<li class="toc-entry toc-h4"><a href="#metoda-synchronized">Metoda synchronized</a></li>
<li class="toc-entry toc-h4"><a href="#nie-synchronizuj-wszystkiego">Nie synchronizuj wszystkiego</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#wątek-w-stanie-waiting">Wątek w stanie WAITING</a>
<ul>
<li class="toc-entry toc-h3"><a href="#komunikacja-pomiędzy-wątkami">Komunikacja pomiędzy wątkami</a>
<ul>
<li class="toc-entry toc-h4"><a href="#producent">Producent</a></li>
<li class="toc-entry toc-h4"><a href="#konsument">Konsument</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#jak-działa-mechanizm-powiadomień">Jak działa mechanizm powiadomień</a>
<ul>
<li class="toc-entry toc-h4"><a href="#poprawny-producent">Poprawny producent</a></li>
<li class="toc-entry toc-h4"><a href="#poprawny-konsument">Poprawny konsument</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#wątek-w-stanie-timed_waiting">Wątek w stanie TIMED_WAITING</a></li>
<li class="toc-entry toc-h2"><a href="#przerywanie-wątku">Przerywanie wątku</a></li>
<li class="toc-entry toc-h2"><a href="#synchronizacja-inaczej--volatile">Synchronizacja inaczej – volatile</a></li>
<li class="toc-entry toc-h2"><a href="#wątki-są-skomplikowane">Wątki są skomplikowane</a></li>
<li class="toc-entry toc-h2"><a href="#dodatkowe-materiały-do-nauki">Dodatkowe materiały do nauki</a></li>
<li class="toc-entry toc-h2"><a href="#zadania">Zadania</a>
<ul>
<li class="toc-entry toc-h3"><a href="#przedstaw-się">Przedstaw się</a></li>
<li class="toc-entry toc-h3"><a href="#przedstaw-się-ii">Przedstaw się II</a></li>
<li class="toc-entry toc-h3"><a href="#wielowątkowe-hello-world">Wielowątkowe Hello world!</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#podsumowanie">Podsumowanie</a></li>
</ul>
          </nav>
          <hr />
          
          <div class="mailerlite__form">
            <script type="text/javascript" src="https://static.mailerlite.com/data/webforms/698980/y1i5k0.js?v7"></script>
          </div>
          <hr />
          <div class="fb-page">
            <a href="https://www.facebook.com/SamouczekProgramisty"><img src="/assets/images/facebook_logo.gif" alt="Profil Samouczka na Facebooku"/></a>
          </div>
        </aside>
        <p class="notice--info">W artykule w zupełności pomijam zagadnienie procesów i zrównoleglania wykonywania zadań przy ich pomocy. Nie poruszam też tematu “event-loop” i przetwarzania asynchronicznego, które niejako związane są z wątkami. Pomijam także dokładny opis klas biblioteki standardowej z pakietu <code class="language-plaintext highlighter-rouge">java.util.concurrent</code> czy temat programowania reaktywnego. Każde z tych zagadnień to temat na co najmniej jeden osobny artykuł.</p>

<h2 id="stwórz-swój-pierwszy-wątek">Stwórz swój pierwszy wątek</h2>

<p>Zacznę od przykładu. Poniższy fragment kodu tworzy nowy wątek. Wewnątrz tego wątku znajduje się pętla, która wypisuje wszystkie liczby od 0 do 4, po czym kończy swoje działanie. Dokładnie taka sama pętla znajduje się w wątku głównym:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MT start"</span><span class="o">);</span>
    <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"T0 start"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"T0 "</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"T0 stop"</span><span class="o">);</span>
    <span class="o">});</span>
    <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MT "</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MT stop"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Wynik działania tej metody może być następujący. W Twoim przypadku może on być zupełnie inny. Uruchom tę metodę kilka razy porównując otrzymany wynik:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MT start
MT 0
T0 start
MT 1
T0 0
T0 1
T0 2
MT 2
T0 3
MT 3
T0 4
T0 stop
MT 4
MT stop
</code></pre></div></div>

<p>Zanim przejdę do dokładnego omówienia tego fragmentu kodu musisz dowiedzieć się czegoś więcej o wątkach i sposobie ich działania.</p>

<h2 id="wątki-w-teorii">Wątki w teorii</h2>

<h3 id="program-bez-wątków">Program bez wątków</h3>

<p>Wyobraź sobie problem, którego rozwiązanie wymaga wykonania trzech zadań. Udało Ci się napisać program, który ten problem rozwiązuje. Uruchamiasz ten program na komputerze. Każde z zadań uruchamiane jest po zakończeniu poprzedniego. Na diagramie może wyglądać to tak:</p>

<figure class="c_img_with_auto">
  <img src="/assets/images/2019/02/03_1_cpu_3_tasks.svg" alt="" /><figcaption>
      Trzy zadania uruchomione sekwencyjne na jednym procesorze.

    </figcaption></figure>

<p>Gwiazdka reprezentuje rdzeń procesora. Różnokolorowe prostokąciki reprezentują trzy zadania do wykonania. Długość prostokącików reprezentuje czas trwania poszczególnych zadań. Zadania uruchamiane są po kolei. Po tym jak skończy się zadanie zielone rozpoczyna się zadanie niebieskie. Można powiedzieć, że zadania uruchamiane są sekwencyjnie.</p>

<h3 id="program-wielowątkowy">Program wielowątkowy</h3>

<p>Przed procesorami wielordzeniowymi wątki były “oszustwem”. Procesor był jeden, mógł pracować wyłącznie nad jednym zadaniem. Wymyślono jednak inne rozwiązanie.</p>

<h4 id="szatkowanie-czasu-">Szatkowanie czasu :)</h4>

<p>Mam na myśli <em>time slicing</em>. Mechanizm dzięki, któremu jeden rdzeń procesora może uruchamiać wiele wątków. Nie dzieje się to jednak równolegle.</p>

<p>Diagram poniżej prezentuje dokładnie te same zadania. Tym razem każde z nich uruchamiane jest w osobnym wątku, mamy zatem trzy wątki. Mechanizm nadzorujący ich pracę zapewnia, że co jakiś czas aktualny wątek zostanie zatrzymany. Mówi się wtedy, że wątek został wywłaszczony. Kolejny wątek zostaje wybudzony, dostaje czas procesora i jest przez niego wykonywany. Suma długości prostokącików w danym kolorze jest dokładnie taka sama jak w poprzednim przykładzie:</p>

<figure class="c_img_with_auto">
  <img src="/assets/images/2019/02/03_1_cpu_3_tasks_threads.svg" alt="" /><figcaption>
      Trzy zadania uruchomione w wątkach na jednym procesorze.

    </figcaption></figure>

<p>Takie podejście ma swoje zalety, jednak nie prowadzi do krótszego czasu działania programu. Wręcz przeciwnie, zatrzymywanie i wybudzanie wątków zajmuje czas. Proszę spójrz na diagram poniżej, który pokazuje czas trwania obu podejść:</p>

<figure class="c_img_with_auto">
  <img src="/assets/images/2019/02/03_1_cpu_3_tasks_threads_comparison.svg" alt="" /><figcaption>
      Porównanie czasu trwania dwóch podejść na jednym procesorze.

    </figcaption></figure>

<p>Po co zatem stosować takie podejście? Najważniejszym argumentem jest to, że w tym przypadku każde z zadań jest delikatnie popychane do przodu. Wyobraź sobie inną sytuację. Załóżmy, że dwa zadania zajmują wyraźnie mniej czasu niż trzecie:</p>

<figure class="c_img_with_auto">
  <img src="/assets/images/2019/02/03_1_cpu_3_uneven_tasks.svg" alt="" /></figure>

<p>W takim przypadku zadania niebieskie i białe muszą czekać na zakończenie zadania zielonego. Zastosowanie wątków w tym przypadku może prowadzić do dużo szybszego zakończenia zadań niebieskiego i białego (chociaż nadal sumaryczny czas, wraz z przełączeniami wątków, będzie dłuższy):</p>

<figure class="c_img_with_auto">
  <img src="/assets/images/2019/02/03_1_cpu_3_uneven_tasks_threads.svg" alt="" /></figure>

<p>Takie podejście pozwala na uniknięcie tak zwanego zagłodzenia (ang. <em>starving</em>) wątków. W powyższym przykładzie bez szatkowania czasu wątek z zadaniem zielonym zagłodziłby wątki z zadaniami niebieskim i białym.</p>

<p>“Szatkowanie czasu” daje wrażenie równoległej pracy wielu wątków, jednak w rzeczywistości w danym momencie tylko jedno zadanie jest uruchomione. Inaczej wygląda sytuacja w przypadku procesorów mających wiele rdzeni.</p>

<h4 id="procesory-wielordzeniowe">Procesory wielordzeniowe</h4>

<p>Procesory wielordzeniowe dają rzeczywistą możliwość uruchamiania wielu zadań równolegle. W takim przypadku, jeśli każde z zadań uruchomione zostanie w osobnym wątku wówczas sytuacja wygląda jak na diagramie poniżej<sup id="fnref:cztery" role="doc-noteref"><a href="#fn:cztery" class="footnote" rel="footnote">1</a></sup>:</p>

<figure class="c_img_with_auto">
  <img src="/assets/images/2019/02/03_3_cpu_3_tasks_threads.svg" alt="" /></figure>

<p>Uruchomienie programu bez wątków na komputerze z procesorem wielordzeniowym nie przyspieszyłoby jego działania – jeden rdzeń sekwencyjnie realizowałby każde z zadań.</p>

<h4 id="połączenie-obu-podejść">Połączenie obu podejść</h4>

<p>W rzeczywistości spotkasz się połączeniem obu podejść<sup id="fnref:rdzenie" role="doc-noteref"><a href="#fn:rdzenie" class="footnote" rel="footnote">2</a></sup>. Proszę spójrz na diagram poniżej. Pokazuje on przykładowe wykonanie zadania na dwóch rdzeniach. Dla porównania pokazałem też sekwencyjne wykonanie tych samych zadań:</p>

<figure class="c_img_with_auto">
  <img src="/assets/images/2019/02/03_2_cpu_3_tasks_threads_comparison.svg" alt="" /><figcaption>
      Trzy zadania uruchomione w wątkach na dwóch procesorach.

    </figcaption></figure>

<h3 id="wspólne-dane">Wspólne dane</h3>

<p>Wątki korzystają z tych samych danych. Mówi się, że wątki współdzielą przestrzeń adresową. Oznacza to tyle, że obiekty dostępne dla jednego wątku są widoczne także w innych wątkach<sup id="fnref:threadlocal" role="doc-noteref"><a href="#fn:threadlocal" class="footnote" rel="footnote">3</a></sup>.</p>

<p>Proszę pamiętaj, że zmienne dostępne są dla wszystkich wątków. W związku z tym wszystkie wątki mogą te zmienne modyfikować. Pociąga to za sobą bardzo poważne konsekwencje. Opiszę je dokładniej w dalszej części artykułu.</p>

<div class="notice--success text-center">
  
<p><span class="c_almost-header">Pobierz opracowania zadań z rozmów kwalifikacyjnych</span></p>

<p>Przygotowałem rozwiązania kilku zadań algorytmicznych z rozmów kwalifikacyjnych. Rozkładam je na czynniki pierwsze i pokazuję różne sposoby ich rozwiązania. Dołącz do grupy <strong>ponad 6147 Samouków</strong>, którzy jako pierwsi dowiadują się o nowych treściach na blogu, a prześlę je na Twój e-mail.</p>

<script type="text/javascript" src="https://static.mailerlite.com/data/webforms/704312/f8q4i2.js?v4"></script>


</div>

<h2 id="tworzenie-nowego-wątku">Tworzenie nowego wątku</h2>

<p>Każdy wątek w języku Java związany jest z klasą <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html"><code class="language-plaintext highlighter-rouge">Thread</code></a>. Wątek można utworzyć na dwa sposoby.</p>

<h3 id="dziedziczenie-po-klasie-thread">Dziedziczenie po klasie <code class="language-plaintext highlighter-rouge">Thread</code></h3>

<p>Pierwszym ze sposobów jest utworzenie własnej klasy, która dziedziczy po klasie <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html"><code class="language-plaintext highlighter-rouge">Thread</code></a>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"I'm inside thread!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyThread</span><span class="o">();</span>
</code></pre></div></div>

<p>W tym przypadku należy nadpisać metodę <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html#run()"><code class="language-plaintext highlighter-rouge">run</code></a> – to właśnie ona zostaje wykonana jako ciało wątku.</p>

<h3 id="implementacja-interfejsu-runnable">Implementacja interfejsu <code class="language-plaintext highlighter-rouge">Runnable</code></h3>

<p>Drugim sposobem jest utworzenie wątku przy pomocy konstruktora, który przyjmuje obiekt implementujący interfejs <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Runnable.html"><code class="language-plaintext highlighter-rouge">Runnable</code></a>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyRunnable</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"I'm inside runnable!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyRunnable</span><span class="o">());</span>
</code></pre></div></div>

<p>Tym razem ciałem wątku jest implementacja metody <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Runnable.html#run()"><code class="language-plaintext highlighter-rouge">run</code></a> z interfejsu <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Runnable.html"><code class="language-plaintext highlighter-rouge">Runnable</code></a>.</p>

<p>Zauważ, że możesz utworzyć wątek posługując się <a href="/klasy-wewnetrzne-i-anonimowe-w-jezyku-java/#klasy-anonimowe">klasami anonimowymi</a>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"I'm inside runnable!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<p>Interfejs <code class="language-plaintext highlighter-rouge">Runnable</code> jest <a href="/wyrazenia-lambda-w-jezyku-java/#interfejs-funkcyjny">interfejsem funkcyjnym</a>. W związku z tym zapis ten można uprościć stosując <a href="/wyrazenia-lambda-w-jezyku-java/">wyrażenia lambda</a>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"I'm inside runnable!"</span><span class="o">));</span>
</code></pre></div></div>

<h2 id="cykl-życia-wątku">Cykl życia wątku</h2>

<p>Utworzenie instancji wątku to dopiero początek. Każdy wątek ma swój cykl życia. Wątki mogą znajdować się w jednym z sześciu stanów. Dopuszczalne stany wątku znajdują się w <a href="/typ-wyliczeniowy-w-jezyku-java/">klasie wyliczeniowej</a> <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.State.html"><code class="language-plaintext highlighter-rouge">Thread.State</code></a>:</p>

<ul>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.State.html#NEW"><code class="language-plaintext highlighter-rouge">NEW</code></a> – nowy wątek, który nie został jeszcze uruchomiony,</li>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.State.html#RUNNABLE"><code class="language-plaintext highlighter-rouge">RUNNABLE</code></a> – wątek, który może wykonywać swój kod,</li>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.State.html#TERMINATED"><code class="language-plaintext highlighter-rouge">TERMINATED</code></a> – wątek, który zakończył swoje działanie,</li>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.State.html#BLOCKED"><code class="language-plaintext highlighter-rouge">BLOCKED</code></a> – wątek zablokowany, oczekujący na zwolnienie współdzielonego zasobu,</li>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.State.html#WAITING"><code class="language-plaintext highlighter-rouge">WAITING</code></a> – wątek uśpiony,</li>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.State.html#TIMED_WAITING"><code class="language-plaintext highlighter-rouge">TIMED_WAITING</code></a> – wątek uśpiony na określony czas.</li>
</ul>

<p>Poniższy diagram pokazuje możliwe przejścia pomiędzy stanami:</p>

<figure class="">
  <img src="/assets/images/2019/02/05_thread_states.svg" alt="" /><figcaption>
      Diagram stanów wątku

    </figcaption></figure>

<p>Przejście ze stanu <code class="language-plaintext highlighter-rouge">NEW</code> do stanu <code class="language-plaintext highlighter-rouge">RUNNABLE</code> odbywa się po wywołaniu metody <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html#start()"><code class="language-plaintext highlighter-rouge">start()</code></a> na instancji wątku. Dopiero wtedy wątek może być wykonywany, samo utworzenie instancji nie powoduje jego uruchomienia. Każdy wątek może być uruchomiony dokładnie raz – dokładanie jeden raz może być na nim wywołana metoda <code class="language-plaintext highlighter-rouge">start()</code>.</p>

<p class="notice--info">Zwróć uwagę na to, że ciałem wątku jest metoda <code class="language-plaintext highlighter-rouge">run</code> a do jego uruchomienia niezbędne jest wywołanie metody <code class="language-plaintext highlighter-rouge">start</code>. Oczywiście możesz uruchomić metodę <code class="language-plaintext highlighter-rouge">run</code> samodzielnie, jednak nie spowoduje to uruchomienia nowego wątku – kod metody <code class="language-plaintext highlighter-rouge">run</code> będzie wykonywany w aktualnym wątku.</p>

<p>Wątek, który skończy swoje działanie, przechodzi do stanu <code class="language-plaintext highlighter-rouge">TERMINATED</code>.</p>

<p>Omówienie stanów <code class="language-plaintext highlighter-rouge">BLOCKED</code>, <code class="language-plaintext highlighter-rouge">WAITING</code> i <code class="language-plaintext highlighter-rouge">TIMED_WAITING</code> wymaga osobnych sekcji. Zanim jednak do tego przejdę szczegółowo omówię przykład, który pokazałem na początku artykułu.</p>

<h2 id="omówienie-przykładu">Omówienie przykładu</h2>

<p>Skoro już znasz podstawy teorii związanej z wątkami mogę przejść do omówienia przykładu z początku artykułu. Dla przypomnienia:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MT start"</span><span class="o">);</span>
    <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"T0 start"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"T0 "</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"T0 stop"</span><span class="o">);</span>
    <span class="o">});</span>
    <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MT "</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MT stop"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Druga linijka metody <code class="language-plaintext highlighter-rouge">main</code> to utworzenie instancji wątku. W tym przypadku użyłem konstruktora przyjmującego obiekt implementujący interfejs <code class="language-plaintext highlighter-rouge">Runnable</code>. Ten obiekt utworzyłem przy pomocy <a href="/wyrazenia-lambda-w-jezyku-java/">wyrażenia lambda</a>. W ciele tego wyrażenia znajduje się pętla wypisująca liczby.</p>

<p>Kolejna linijka kodu, <code class="language-plaintext highlighter-rouge">thread.start();</code>, uruchamia wątek. Bez niej kod wewnątrz interfejsu <code class="language-plaintext highlighter-rouge">Runnable</code> nie zostałby wykonany. Po uruchomieniu wątku znajdziesz kolejną pętlę wypisującą liczby. Powyższy fragment kodu działa w dwóch wątkach:</p>
<ul>
  <li>wątku o domyślnej nazwie <code class="language-plaintext highlighter-rouge">main</code>, który tworzony jest automatycznie. Wewnątrz niego uruchomiona jest metoda <code class="language-plaintext highlighter-rouge">main</code>,</li>
  <li>wątku o domyślnej nazwie <code class="language-plaintext highlighter-rouge">Thread-0</code><sup id="fnref:nazwa" role="doc-noteref"><a href="#fn:nazwa" class="footnote" rel="footnote">4</a></sup>, który utworzyłem i uruchomiłem samodzielnie.</li>
</ul>

<p>Kilkukrotne uruchomienie tego kodu pokazuje Ci, że działanie tych dwóch wątków może przeplatać się na różne sposoby.</p>

<h2 id="wątek-w-stanie-blocked">Wątek w stanie <code class="language-plaintext highlighter-rouge">BLOCKED</code></h2>

<p>Wątek, który znajduje się w stanie <code class="language-plaintext highlighter-rouge">BLOCKED</code> oczekuje na pewien zablokowany zasób. W języku Java blokowanie odbywa się przy pomocy tak zwanych monitorów, które służą do synchronizacji wątków. Zanim powiem Ci jak synchronizować wątki między sobą muszę pokazać Ci dlaczego taka synchronizacja jest czasami niezbędna.</p>

<h3 id="dlaczego-synchronizacja-jest-potrzebna">Dlaczego synchronizacja jest potrzebna?</h3>

<p>Wiesz już, że wątki współdzielą przestrzeń adresową. Wspomniałem już, że ma to bardzo istotne konsekwencje. Pokażę Ci je na poniższym przykładzie:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Counter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">increment</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RaceCondition</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Counter</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Counter</span><span class="o">();</span>
        <span class="nc">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100_000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">c</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t3</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Tutaj nowością dla Ciebie jest metoda <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html#join()"><code class="language-plaintext highlighter-rouge">Thread.join()</code></a>. Metoda ta zapewnia, że aktualny wątek czeka na zakończenie się wątku, na którym <code class="language-plaintext highlighter-rouge">join</code> zostało wywołane. W przykładzie powyżej domyślny wątek <code class="language-plaintext highlighter-rouge">main</code> czeka na zakończenie się wątku <code class="language-plaintext highlighter-rouge">t1</code>, jak ten się skończy czeka na zakończenie wątku <code class="language-plaintext highlighter-rouge">t2</code> i następnie <code class="language-plaintext highlighter-rouge">t3</code>.</p>

<p class="notice--info">Tutaj drobna dygresja. To, że <code class="language-plaintext highlighter-rouge">main</code> czeka na wątki w kolejności <code class="language-plaintext highlighter-rouge">t1</code>, <code class="language-plaintext highlighter-rouge">t2</code> i <code class="language-plaintext highlighter-rouge">t3</code> nie oznacza, że te wątki skończą się w tej kolejności. W praktyce kolejność ta może być dowolna, w szczególności może także być odwrotna.</p>

<p>W powyższym fragmencie kodu tworzę obiekt <code class="language-plaintext highlighter-rouge">r</code>, który implementuje interfejs <code class="language-plaintext highlighter-rouge">Runnable</code>. Następnie używając tej instancji tworzę trzy wątki, uruchamiam je i czekam na ich zakończenie. <code class="language-plaintext highlighter-rouge">r</code> używa zmiennej lokalnej <code class="language-plaintext highlighter-rouge">c</code> typu <code class="language-plaintext highlighter-rouge">Counter</code>. Używa jej do zwiększenia wartości atrybutu <code class="language-plaintext highlighter-rouge">value</code> o 100’000.</p>

<p>Skoro są trzy wątki, każdy z nich zwiększa wartość zmiennej o 1 i robi to 100’000 razy to wartość <code class="language-plaintext highlighter-rouge">value</code> powinna wynosić 300’000, prawda? Spróbuj uruchomić ten kod kilka razy. Jakie wyniki otrzymujesz? W moim przypadku pięć kolejnych uruchomień zwróciło takie wyniki:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>235239
296424
300000
281814
300000
</code></pre></div></div>

<h3 id="wyścig">Wyścig</h3>

<p>To co udało Ci się zaobserwować wyżej to tak zwany wyścig (ang. <em>race condition</em>). Taka sytuacja zachodzi jeśli kilka wątków jednocześnie modyfikuje zmienną, która do takiej równoległej zmiany nie jest przystosowana. Tylko dlaczego wartość atrybutu <code class="language-plaintext highlighter-rouge">value</code> miała tak różne wartości? Działo się tak dlatego, że operacja <code class="language-plaintext highlighter-rouge">value += 1</code> nie jest operacją atomową.</p>

<p>Tutaj należy Ci się kolejne wyjaśnienie. Operacja atomowa to taka operacja, która jest niepodzielna. Operacja atomowa realizowana jest przy pomocy jednej instrukcji w bytecode (w skompilowanej klasie). Operacja <code class="language-plaintext highlighter-rouge">value += 1</code> nie jest operacją atomową, jest ona równoważna z <code class="language-plaintext highlighter-rouge">value = value + 1</code>. Wykonanie tej operacji składa się z kilku kroków:</p>

<ol>
  <li>pobrania aktualnej wartości <code class="language-plaintext highlighter-rouge">value</code> do zmiennej tymczasowej (niewidocznej w kodzie źródłowym)<sup id="fnref:stos" role="doc-noteref"><a href="#fn:stos" class="footnote" rel="footnote">5</a></sup>,</li>
  <li>dodania <code class="language-plaintext highlighter-rouge">1</code> do zmiennej tymczasowej,</li>
  <li>przypisanie powiększonej wartości do <code class="language-plaintext highlighter-rouge">value</code>.</li>
</ol>

<p>W bytecode ten fragment wygląda tak:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GETFIELD pl/samouczekprogramisty/kursjava/treads/Counter.value : I
ICONST_1
IADD
PUTFIELD pl/samouczekprogramisty/kursjava/treads/Counter.value : I
</code></pre></div></div>

<h4 id="przykład-zachowania-wątków">Przykład zachowania wątków</h4>

<p>Pamiętasz szatkowanie czasu, które opisałem na początku artykułu? Odgrywa ono tu kluczową rolę. Wyobraź sobie sytuację, w której wątek zielony wykonał krok 1., 2. i 3. po czym został wywłaszczony. Następnie wątki niebieski i biały wykonały krok 1. Po czym wątek niebieski wykonał kroki 2. i 3. Po chwili to samo stało się z wątkiem białym. Taką sytuację pokazuje poniższy diagram:</p>

<figure class="">
  <img src="/assets/images/2019/02/11_slicing_time_example.svg" alt="" /><figcaption>
      Przykład zachowania wątków

    </figcaption></figure>

<p>Biorąc pod uwagę takie zachowanie wątków, jaką wartość wątek biały przypisał do <code class="language-plaintext highlighter-rouge">value</code>? Była to wartość <code class="language-plaintext highlighter-rouge">2</code>, przez co cała praca wątku niebieskiego została nadpisana. Proszę spójrz na tabelkę niżej, która pokazuje tę sytuację:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Operacja</th>
      <th>Wątek</th>
      <th>Krok</th>
      <th>Wartość <code class="language-plaintext highlighter-rouge">value</code></th>
      <th>Wartość zmiennej tymczasowej</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1.</td>
      <td>zielony</td>
      <td>1.</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <td style="text-align: center">2.</td>
      <td>zielony</td>
      <td>2.</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td style="text-align: center">3.</td>
      <td>zielony</td>
      <td>3.</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td style="text-align: center">4.</td>
      <td>niebieski</td>
      <td>1.</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td style="text-align: center">5.</td>
      <td>biały</td>
      <td>1.</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td style="text-align: center">6.</td>
      <td>niebieski</td>
      <td>2.</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <td style="text-align: center">7.</td>
      <td>niebieski</td>
      <td>3.</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <td style="text-align: center">8.</td>
      <td>biały</td>
      <td>2.</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <td style="text-align: center">9.</td>
      <td>biały</td>
      <td>3.</td>
      <td>2</td>
      <td>2</td>
    </tr>
  </tbody>
</table>

<p>Jest to jeden z możliwych scenariuszy. W przykładzie powyżej operacja 9. ustawiają wartość <code class="language-plaintext highlighter-rouge">value</code> na <code class="language-plaintext highlighter-rouge">2</code> w wątku białym ignorując zwiększenie wartości wykonane przez wątek niebieski w operacji 7.</p>

<p>Aby uniknąć takich sytuacji, uniknąć wyścigów, niezbędna jest synchronizacja pracy wątków.</p>

<h3 id="synchronizacja-wątków">Synchronizacja wątków</h3>

<p>Każdy obiekt w języku Java powiązany jest z tak zwanym monitorem. Każdy monitor może być w jednym z dwóch stanów: odblokowany albo zablokowany. Monitor może być zablokowany wyłącznie przez jeden wątek w danym momencie. Dzięki tej właściwości to obiekty używane są do tego, żeby synchronizować wątki ze sobą. Służy do tego słowo kluczowe <code class="language-plaintext highlighter-rouge">synchronized</code>.</p>

<h4 id="blok-synchronized">Blok <code class="language-plaintext highlighter-rouge">synchronized</code></h4>

<p>Proszę spójrz na delikatnie zmodyfikowany kod klasy <code class="language-plaintext highlighter-rouge">Counter</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Counter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">increment</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Spróbuj jeszcze raz uruchomić <code class="language-plaintext highlighter-rouge">RaceCondition</code> po wprowadzeniu takiej modyfikacji. Jak z wynikami? Tym razem na pewno za każdym razem na konsoli pokaże się liczba 300’000. Dzieje się tak ponieważ ciało metody <code class="language-plaintext highlighter-rouge">increment</code> objęte jest blokiem <code class="language-plaintext highlighter-rouge">synchronized</code>. W tym przypadku obiektem, który został użyty jako monitor jest <code class="language-plaintext highlighter-rouge">this</code> – instancja <code class="language-plaintext highlighter-rouge">Counter</code>. Blok <code class="language-plaintext highlighter-rouge">synchronized</code> ma następujący format:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">synchronized</span> <span class="o">(</span><span class="n">obiekt</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// synchronizowany kod</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Masz pewność, że wszystko co znajduje się wewnątrz bloku w każdym momencie uruchomione jest przez maksymalnie jeden wątek.</p>

<h4 id="metoda-synchronized">Metoda <code class="language-plaintext highlighter-rouge">synchronized</code></h4>

<p>Słowo kluczowe <code class="language-plaintext highlighter-rouge">synchronized</code> może być także użyte w innym kontekście. Może także oznaczyć metody, które są synchronizowane. Na przykład:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">increment</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>W praktyce obie wersje metody <code class="language-plaintext highlighter-rouge">increment</code> są równoważne. Oznaczenie metody słowem kluczowym <code class="language-plaintext highlighter-rouge">synchronized</code> równoznaczne jest w umieszczeniem całego ciała metody w bloku <code class="language-plaintext highlighter-rouge">synchronized</code>. To jaki obiekt użyty jest w roli monitora zależy od rodzaju metody:</p>

<ul>
  <li>standardowa metoda – jako monitor użyta jest instancja klasy – <code class="language-plaintext highlighter-rouge">this</code>,</li>
  <li>metoda statyczna – jako monitor użyta jest klasa.</li>
</ul>

<p>Na przykład dwa poniższe fragmenty kodu są równoważne:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Counter</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sampleStaticMethod</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="err">'</span><span class="n">xxx</span><span class="err">'</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Counter</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sampleStaticMethod</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">Counter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="err">'</span><span class="n">xxx</span><span class="err">'</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="nie-synchronizuj-wszystkiego">Nie synchronizuj wszystkiego</h4>

<p>Synchronizacja wątków pozwala na uniknięcie wielu problemów związanych na przykład z wyścigami. Niestety ma też swoje słabe strony. Pamiętaj, że cały kod, który jest w bloku <code class="language-plaintext highlighter-rouge">synchronized</code> w danym momencie może być uruchomiony przez maksymalnie jeden wątek. W związku z tym ten fragment kodu traci możliwość równoczesnego uruchomienia na kilku procesorach – spowalnia wykonanie programu wielowątkowego.</p>

<p>Taki fragment kodu, który w danym momencie może być użyty przez maksymalnie jeden wątek nazywany jest sekcją krytyczną. Dobrą zasadą jest ograniczanie sekcji krytycznej – im mniej w niej kodu tym większy zysk z użycia wielu wątków.</p>

<p>Synchronizacja wątków przy pomocy <code class="language-plaintext highlighter-rouge">synchronized</code> to nie wszystko. Wszystkie obiekty w języku Java, poza monitorami, zawierają specjalny zbiór wątków (ang. <em>wait set</em>). Elementami tego zbioru są wątki, które czekają na powiadomienia dotyczące tego obiektu.</p>

<h2 id="wątek-w-stanie-waiting">Wątek w stanie <code class="language-plaintext highlighter-rouge">WAITING</code></h2>

<p>Jednym ze sposobów aby wątek znalazł się w tym stanie jest wywołanie metody <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html#join()"><code class="language-plaintext highlighter-rouge">Thread.join()</code></a>. Wiesz już, że w takim przypadku aktualny wątek czeka na zakończenie swojego kolegi.</p>

<p>Wątek znajdzie się w stanie <code class="language-plaintext highlighter-rouge">WAITING</code> także jeśli w trakcie jego działania zostanie wywołana metoda <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait()"><code class="language-plaintext highlighter-rouge">Object.wait()</code></a><sup id="fnref:pomijam" role="doc-noteref"><a href="#fn:pomijam" class="footnote" rel="footnote">6</a></sup>.</p>

<p>Na Samouczku Programisty takie lakoniczne wytłumaczenie nie przejdzie ;). Zapraszam Cię do przykładu, opisującego drugą sytuację.</p>

<h3 id="komunikacja-pomiędzy-wątkami">Komunikacja pomiędzy wątkami</h3>

<p>Wyobraź sobie sytuację, w której masz dwa wątki. Jeden produkuje pewne dane, drugi je konsumuje. Tego typu mechanizm jest dość często spotykany. Naiwna implementacja tego typu zachowania może wyglądać tak:</p>

<p class="notice--warning">Ten przykład pokazuje złe praktyki, zanim zaczniesz pisać wielowątkowy kod w ten sposób przeczytaj wyjaśnienie poniżej wraz z poprawną wersją implementacji!</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NaiveConsumerProducer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Random</span> <span class="n">generator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Queue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">itemCount</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
        <span class="nc">Thread</span> <span class="n">producer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">itemCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="n">generator</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">5</span><span class="o">)).</span><span class="na">toMillis</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"Item no. "</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">Thread</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">itemsLeft</span> <span class="o">=</span> <span class="n">itemCount</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">itemsLeft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">item</span><span class="o">;</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">itemsLeft</span><span class="o">--;</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Consumer got item: "</span> <span class="o">+</span> <span class="n">item</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="n">consumer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">producer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>W przykładzie tym użyłem <a href="/struktury-danych-lista-wiazana/">listy wiązanej</a> jako kolejki. Obiekt <code class="language-plaintext highlighter-rouge">queue</code> będzie służył jako narzędzie do wymiany danych pomiędzy wątkami.</p>

<h4 id="producent">Producent</h4>

<p>Zacznę od wątku produkującego dane:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Thread</span> <span class="n">producer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">itemCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="n">generator</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">5</span><span class="o">)).</span><span class="na">toMillis</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"Item no. "</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<p>W ciele wątku znajduje się pętla, która produkuje zadaną liczbę elementów. Nowością dla Ciebie jest metoda <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html#sleep(long)"><code class="language-plaintext highlighter-rouge">Thread.sleep()</code></a>. Służy ona do uśpienia wątku<sup id="fnref:timed_wait" role="doc-noteref"><a href="#fn:timed_wait" class="footnote" rel="footnote">7</a></sup>. Przekazany parametr mówi o minimalnym czasie, przez który dany wątek będzie uśpiony – nie będzie zajmował czasu procesora. W ten sposób symuluję opóźnienia związane z produkcją elementów. To opóźnienie może być różne dla poszczególnych elementów. Użyłem tu instancji klasy <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/Random.html"><code class="language-plaintext highlighter-rouge">Random</code></a>, żeby to symulować.</p>

<p>Na razie pominę obsługę wyjątku <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/InterruptedException.html"><code class="language-plaintext highlighter-rouge">InterruptedException</code></a>. Nie jest ona istotna w tym przykładzie, omówię ją dokładnie w jednym z kolejnych akapitów.</p>

<p>Następnie w bloku <code class="language-plaintext highlighter-rouge">synchronized</code> dodaje nowy element. Zwróć uwagę, że do synchronizacji używam tu obiektu <code class="language-plaintext highlighter-rouge">queue</code>. Dzięki temu mam pewność, że nie nastąpi wyścig podczas dodawania czy usuwania elementów z kolejki.</p>

<p>Wątek kończy swoje działanie po wyprodukowaniu wszystkich elementów.</p>

<h4 id="konsument">Konsument</h4>

<p>Wątek konsumujący wyprodukowane elementy wygląda tak:</p>

<p class="notice--warning">Ten przykład pokazuje złe praktyki, zanim zaczniesz pisać wielowątkowy kod w ten sposób przeczytaj wyjaśnienie poniżej wraz z poprawną wersją implementacji!</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Thread</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">itemsLeft</span> <span class="o">=</span> <span class="n">itemCount</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">itemsLeft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">item</span><span class="o">;</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">itemsLeft</span><span class="o">--;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Consumer got item: "</span> <span class="o">+</span> <span class="n">item</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<p>Wątek konsumujący dane także używa <a href="/petle-i-instrukcje-warunkowe-w-jezyku-java/">pętli</a>. Tym razem jest to pętla <code class="language-plaintext highlighter-rouge">while</code>, która wykonuje się dopóki oczekiwana liczba elementów nie zostanie pobrana z kolejki. Także tutaj wątek używa bloku <code class="language-plaintext highlighter-rouge">synchronized</code>, w który sprawdza czy elementy są w kolejce i do ewentualnego ich pobrania.</p>

<p>Program działa. Ma jednak pewien subtelny błąd. Zwróć uwagę na wątek konsumenta. Wątek ten działa bez przerwy. Bez przerwy zajmuje czas procesora<sup id="fnref:wywlaszczenia" role="doc-noteref"><a href="#fn:wywlaszczenia" class="footnote" rel="footnote">8</a></sup>. Co więcej, przez większość swojego czasu kręci się wewnątrz pętli sprawdzając czy kolejka jest pusta. Jako drobne ćwiczenie dla Ciebie zostawiam dodanie licznika iteracji – ile razy pętla wykonała się w Twoim przypadku?</p>

<p>Jak można ten problem rozwiązać? Jednym ze sposobów może być usypianie wątku konsumenta używając metody <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html#sleep(long)"><code class="language-plaintext highlighter-rouge">Thread.sleep()</code></a>, którą już znasz. To także byłoby marnowanie zasobów – skąd możesz wiedzieć jak długo zajmie produkowanie kolejnego elementu?</p>

<p>Z pomocą przychodzi mechanizm powiadomień.</p>

<h3 id="jak-działa-mechanizm-powiadomień">Jak działa mechanizm powiadomień</h3>

<p>Wiesz już, że każdy obiekt powiązany jest z monitorem używamy w trakcie synchronizacji. Podobnie wygląda sprawa w przypadku mechanizmu powiadomień. Każdy obiekt w języku Java posiada zbiór   powiadamianych wątków (ang. <em>waiting set</em>).</p>

<p>Wewnątrz tego zbioru znajdują się wątki, które czekają na powiadomienie dotyczące danego obiektu. Jedynym sposobem, żeby modyfikować zawartość tego zbioru jest używanie metod dostępnych w klasie <code class="language-plaintext highlighter-rouge">Object</code>:</p>

<ul>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait()"><code class="language-plaintext highlighter-rouge">Object.wait()</code></a> – dodanie aktualnego wątku do zbioru powiadamianych wątków,</li>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#notify()"><code class="language-plaintext highlighter-rouge">Object.notify()</code></a> – powiadomienie i wybudzenie jednego z oczekujących wątków,</li>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#notifyAll()"><code class="language-plaintext highlighter-rouge">Object.notifyAll()</code></a> – powiadomienie i wybudzenie wszystkich oczekujących wątków.</li>
</ul>

<h4 id="poprawny-producent">Poprawny producent</h4>

<p>Poprawna wersja producenta używa metody <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#notify()"><code class="language-plaintext highlighter-rouge">notify</code></a> albo <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#notifyAll()"><code class="language-plaintext highlighter-rouge">notifyAll</code></a> informując w ten sposób konsumentów o nowym elemencie:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Thread</span> <span class="n">producer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">itemCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="n">generator</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">5</span><span class="o">)).</span><span class="na">toMillis</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"Item no. "</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<h4 id="poprawny-konsument">Poprawny konsument</h4>

<p>Poprawna wersja konsumenta oczekuje pasywnie na informację od producenta o nowym elemencie:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Thread</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">itemsLeft</span> <span class="o">=</span> <span class="n">itemCount</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">itemsLeft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">item</span><span class="o">;</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">queue</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">itemsLeft</span><span class="o">--;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Consumer got item: "</span> <span class="o">+</span> <span class="n">item</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<p>Należy Ci się drobne wyjaśnienie nowego fragmentu:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">queue</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Specyfikacja języka Java pozwala na fałszywe wybudzenia (ang. <em>spurious wake-ups</em>). Są to wybudzenia, które mogą wystąpić nawet gdy nie było odpowiadającego im powiadomienia – wywołania metody <code class="language-plaintext highlighter-rouge">notify</code>. Dlatego właśnie sprawdzenie warunku (<code class="language-plaintext highlighter-rouge">queue.isEmpty()</code>) musi być wykonane w pętli.</p>

<h2 id="wątek-w-stanie-timed_waiting">Wątek w stanie <code class="language-plaintext highlighter-rouge">TIMED_WAITING</code></h2>

<p>Tym razem będzie krótko ;). Stan <code class="language-plaintext highlighter-rouge">TIMED_WAITING</code> jest podobny do stanu <code class="language-plaintext highlighter-rouge">WAITING</code>. W tym przypadku wątek oczekuje przez pewien czas, nie krótszy niż podany jako argument do jednej z metod<sup id="fnref:pomijam2" role="doc-noteref"><a href="#fn:pomijam2" class="footnote" rel="footnote">9</a></sup>:</p>

<ul>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Object.html#wait(long)"><code class="language-plaintext highlighter-rouge">Object.wait()</code></a> – dodanie aktualnego wątku do zbioru powiadamianych wątków i wybudzenie go po określonym czasie,</li>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html#sleep(long)"><code class="language-plaintext highlighter-rouge">Thread.sleep()</code></a> – wątek wywołujący tę metodę usypia na określony czas,</li>
  <li><a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html#join(long)"><code class="language-plaintext highlighter-rouge">Thread.join()</code></a> – oczekiwanie na zakończenie wątku przez określony czas.</li>
</ul>

<h2 id="przerywanie-wątku">Przerywanie wątku</h2>

<p>W jednym z poprzednich przykładów wspomniałem o wyjątku <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/InterruptedException.html"><code class="language-plaintext highlighter-rouge">InterruptedException</code></a>. Wyjątek ten sygnalizuje sytuację, w której wątek został przerwany. Wątek może zostać przerwany po wywołaniu na jego instancji metody <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html#interrupt()"><code class="language-plaintext highlighter-rouge">Thread.interrupt</code></a>.</p>

<p>W momencie kiedy wątek zostaje przerwany ustawiana jest na nim specjalna flaga, która o tym informuje.</p>

<p>Jeśli chcesz sprawdzić, czy aktualny wątek jest przerwany możesz wywołać statyczną metodę <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/Thread.html#interrupted()"><code class="language-plaintext highlighter-rouge">Thread.interrupted</code></a>. Wywołanie tej metody zwraca <code class="language-plaintext highlighter-rouge">true</code> jeśli wątek był przerwany jednocześnie usuwając flagę, o której wspomniałem przed chwilą.</p>

<h2 id="synchronizacja-inaczej--volatile">Synchronizacja inaczej – <code class="language-plaintext highlighter-rouge">volatile</code></h2>

<p>Java udostępnia jeszcze jeden mechanizm, który pozwala na synchronizację. Mam tu na myśli słowo kluczowe <code class="language-plaintext highlighter-rouge">volatile</code>. Specyfikacja języka Java mówi, że każdy odczyt atrybutu poprzedzonego tym słowem kluczowym następuje po jego zapisie. Innymi słowy, modyfikator <code class="language-plaintext highlighter-rouge">volatile</code> gwarantuje, że każdy wątek czytający dany atrybut zobaczy najnowszą zapisaną wartość tego atrybutu.</p>

<p>Dzięki temu możesz osiągnąć synchronizację wartości danego pola pomiędzy wątkami. Musisz jednak uważać na modyfikacje, które nie są atomowe – przed zmianami tego typu <code class="language-plaintext highlighter-rouge">volatile</code> niestety Cię nie uchroni. W takim przypadku niezbędna będzie synchronizacja, którą opisałem wcześniej.</p>

<p>Poniższy fragment kodu pokazuje poprawne użycie modyfikatora <code class="language-plaintext highlighter-rouge">volatile</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">VolatileExample</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isDone</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">backgroundJob</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="na">toMillis</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"I'm done with my job!"</span><span class="o">);</span>
            <span class="n">isDone</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">});</span>
        <span class="nc">Thread</span> <span class="n">heavyWorker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">LocalDateTime</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(!</span><span class="n">isDone</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// constantly doing some important stuff</span>
            <span class="o">}</span>
            <span class="kt">long</span> <span class="n">durationInMillis</span> <span class="o">=</span> <span class="nc">ChronoUnit</span><span class="o">.</span><span class="na">MILLIS</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"I've been notified about finished job after "</span> <span class="o">+</span> <span class="n">durationInMillis</span> <span class="o">+</span> <span class="s">" milliseconds."</span><span class="o">);</span>
        <span class="o">});</span>

        <span class="n">heavyWorker</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">backgroundJob</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>W ramach ćwiczenia możesz spróbować uruchomić powyższy kod usuwając modyfikator <code class="language-plaintext highlighter-rouge">volatile</code> dla pola <code class="language-plaintext highlighter-rouge">isDone</code>. Jak zachowuje się ten program po takiej modyfikacji?</p>

<h2 id="wątki-są-skomplikowane">Wątki są skomplikowane</h2>

<p>Tworzenie programów wielowątkowych jest trudne. Unikanie zakleszczeń, odpowiednia synchronizacja, unikanie wyścigów nie jest trywialne. Nie przejmuj się, jeśli nie zrozumiesz tego zagadnienia od razu. Pisanie wydajnego, bezpiecznego kodu wielowątkowego to coś, z czym nawet bardzo doświadczeni programiści mogą mieć sporo problemów.</p>

<p>Odnajdowanie i naprawianie błędów w programach, które używają wielu wątków to także ciężkie zadanie. Sytuacja, w której kod działa idealnie w trakcie testów, a zachowuje się dziwnie w środowisku wielowątkowym jest czymś powszechnym.</p>

<p>Zanim zaczniesz pisać kod, który ma być wielowątkowo bezpieczny spróbuj znaleźć gotową implementację w pakiecie <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/concurrent/package-summary.html"><code class="language-plaintext highlighter-rouge">java.util.concurrent</code></a>. Używając klas z tego pakietu na pewno unikniesz sporo ciężkich do zdiagnozowania błędów.</p>

<h2 id="dodatkowe-materiały-do-nauki">Dodatkowe materiały do nauki</h2>

<p>Przygotowałem dla Ciebie zestaw linków, które mogą pomóc Ci spojrzeć na temat wątków z innej strony:</p>

<ul>
  <li><a href="https://docs.oracle.com/javase/tutorial/essential/concurrency/index.html">Tutorial na stronie Oracle’a dotyczący wątków</a>,</li>
  <li><a href="https://docs.oracle.com/javase/specs/jls/se12/html/jls-17.html">Rozdział w Java Language Specification dotyczący wątków</a>,</li>
  <li><a href="https://docs.oracle.com/javase/specs/jls/se12/html/jls-8.html#jls-8.4.3.6">Sekcja w Java Language Specification dotycząca metod synchronizowanych</a>,</li>
  <li><a href="https://docs.oracle.com/javase/specs/jls/se12/html/jls-14.html#jls-14.19">Sekcja w Java Language Specification dotycząca bloku synchronizowanego</a>,</li>
  <li><a href="https://www.ibm.com/developerworks/java/library/j-jtp06197/">Artykuł opisujący użycie zmiennych <code class="language-plaintext highlighter-rouge">volatile</code></a>,</li>
  <li><a href="https://github.com/SamouczekProgramisty/KursJava/tree/master/34_watki/src/main/java/pl/samouczekprogramisty/kursjava/treads">Kod źródłowy przykładów użytych w artykule</a></li>
</ul>

<p>Jeśli znasz źródło, które Twoim zdaniem warte jest uwagi daj znać – dodam je do listy.</p>

<h2 id="zadania">Zadania</h2>

<p>Przygotowałem dla Ciebie zadania, które pomogą Ci przećwiczyć wiedzę przedstawioną w artykule w praktyce. Pamiętaj, że zawsze możesz rzucić okiem na <a href="https://github.com/SamouczekProgramisty/KursJava/tree/master/34_watki/src/main/java/pl/samouczekprogramisty/kursjava/treads/exercise">przykładowe rozwiązania</a>. Jak zwykle zachęcam Cię do samodzielnej próby rozwiązania tych zadań, w ten sposób nauczysz się najwięcej.</p>

<h3 id="przedstaw-się">Przedstaw się</h3>

<p>Napisz metodę, która przyjmuje liczbę całkowitą. Wywołanie metody powinno uruchomić wątek 0., wewnątrz tego wątku powinien zostać uruchomiony wątek 1. Wątek 1. powinien uruchomić wątek 2. itd. do osiągnięcia zadanej liczby wątków. Każdy z wątków powinien wypisać na konsolę swoją domyślną nazwę.</p>

<p>Na przykład wywołanie metody:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">startNestedThreads</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
</code></pre></div></div>

<p>Powinno skończyć się uruchomieniem 3 wątków i wypisaniem tekstu na konsolę:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread-0
Thread-1
Thread-2
</code></pre></div></div>

<h3 id="przedstaw-się-ii">Przedstaw się II</h3>

<p>Zmodyfikuj program z poprzedniego punktu w taki sposób, aby wątki wypisywały swoją nazwę w kolejności odwrotnej do ich tworzenia. Tzn. wątek uruchomiony jako pierwszy powinien wypisać swoją nazwę jako ostatni. Na przykład wywołanie metody:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">startNestedThreads</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
</code></pre></div></div>

<p>Powinno skończyć się uruchomieniem 3 wątków i wypisaniem tekstu na konsolę:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread-2
Thread-1
Thread-0
</code></pre></div></div>

<h3 id="wielowątkowe-hello-world">Wielowątkowe <code class="language-plaintext highlighter-rouge">Hello world!</code></h3>

<p>Napisz program, który uruchomi trzy wątki. Pierwszy z nich będzie wypisywał w pętli ciąg znaków <code class="language-plaintext highlighter-rouge">Hello </code>, drugi <code class="language-plaintext highlighter-rouge">world</code>, trzeci <code class="language-plaintext highlighter-rouge">!\n</code> (wykrzyknik ze znakiem nowej linii). Na przykład:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Hello "</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
<span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

<span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"world"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
<span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

<span class="nc">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
<span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</code></pre></div></div>

<p>Uzupełniając powyższy kod o podstawowe mechanizmy synchronizacji wątków spraw, że program po zakończeniu wypisze linijki tekstu zawierające <code class="language-plaintext highlighter-rouge">Hello world!</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello world!
Hello world!
Hello world!
Hello world!
</code></pre></div></div>

<p>Czy Twój program nadal będzie dział poprawnie jeśli będzie wypisywał “Hello world!” 10’000 razy?</p>

<h2 id="podsumowanie">Podsumowanie</h2>

<p>Po lekturze tego artykułu wiesz czym są wątki. Wiesz jak je tworzyć i uruchamiać. Znasz podstawowe mechanizmy ich synchronizacji. Udało ci się też poznać kilka definicji związanych z programowaniem współbieżnym. Po wykonaniu zadań wiesz, że potrafisz wykorzystać tę wiedzę w praktyce – gratulacje!</p>

<p>Bałem się tego artykułu. Od samego początku pracy nad kursem Javy przesuwałem go w czasie. Teraz, po jego ukończeniu wiem dlaczego ;). Żaden artykuł na blogu nie kosztował mnie tyle pracy. Mam nadzieję, że efekt przypadł Ci do gustu. Proszę podziel się nim z osobami, którym może pomóc. Dzięki temu uda mi się dotrzeć do nowych Czytelników, a na tym właśnie mi zależy – z góry bardzo dziękuję!</p>

<p>Jeśli nie chcesz pominąć kolejnych artykułów dopisz się do samouczkowego newsletter’a i polub Samouczka na Facebook’u. To tyle na dzisiaj, trzymaj się i do następnego razu!</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:cztery" role="doc-endnote">
      <p>Możesz założyć, że program został uruchomiony na procesorze czterordzeniowym. Czwarty rdzeń nie był uwzględniony na diagramie. <a href="#fnref:cztery" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:rdzenie" role="doc-endnote">
      <p>Raczej mało prawdopodobne jest to, że masz komputer, który ma tylko jeden rdzeń procesora. <a href="#fnref:rdzenie" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:threadlocal" role="doc-endnote">
      <p>Dla uproszczenia pomijam tutaj <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/lang/ThreadLocal.html"><code class="language-plaintext highlighter-rouge">ThreadLocal</code></a>. <a href="#fnref:threadlocal" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:nazwa" role="doc-endnote">
      <p>Tworząc nowe wątki masz możliwość nadawania im nazw, jeśli tego nie zrobisz dostają domyślną w formacie <code class="language-plaintext highlighter-rouge">Thread-&lt;kolejny numer&gt;</code>. Masz także możliwość pobrania nazwy aktualnie uruchomionego wątku używając <code class="language-plaintext highlighter-rouge">Thread.currentThread().getName()</code>. <a href="#fnref:nazwa" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:stos" role="doc-endnote">
      <p>W rzeczywistości zmienną tymczasową jest stos, na którym ląduje wartość atrybutu. <a href="#fnref:stos" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:pomijam" role="doc-endnote">
      <p>Pomijam tu trzeci możliwy przypadek – wywołanie metody <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/concurrent/locks/LockSupport.html#park()"><code class="language-plaintext highlighter-rouge">LockSupport.park</code></a>. <a href="#fnref:pomijam" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:timed_wait" role="doc-endnote">
      <p>Metoda ta sprawia, że wątek jest w stanie <code class="language-plaintext highlighter-rouge">TIMED_WAITING</code> o czym przeczytasz za chwilę. <a href="#fnref:timed_wait" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:wywlaszczenia" role="doc-endnote">
      <p>Pomijam wywłaszczenia, które znasz z początku artykułu. <a href="#fnref:wywlaszczenia" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:pomijam2" role="doc-endnote">
      <p>Także tutaj pomijam metody z klasy <code class="language-plaintext highlighter-rouge">LockSupport</code>: <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/concurrent/locks/LockSupport.html#parkNanos(java.lang.Object,long)"><code class="language-plaintext highlighter-rouge">LockSupport.partNanos</code></a> i <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/concurrent/locks/LockSupport.html#parkUntil(java.lang.Object,long)"><code class="language-plaintext highlighter-rouge">LockSupport.parkUntil</code></a>. <a href="#fnref:pomijam2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

        

<div class="notice--success text-center">
  
<p><span class="c_almost-header">Pobierz opracowania zadań z rozmów kwalifikacyjnych</span></p>

<p>Przygotowałem rozwiązania kilku zadań algorytmicznych z rozmów kwalifikacyjnych. Rozkładam je na czynniki pierwsze i pokazuję różne sposoby ich rozwiązania. Dołącz do grupy <strong>ponad 6147 Samouków</strong>, którzy jako pierwsi dowiadują się o nowych treściach na blogu, a prześlę je na Twój e-mail.</p>

<script type="text/javascript" src="https://static.mailerlite.com/data/webforms/698960/m0b4d5.js?v4"></script>


</div>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Kategorie: </strong>
    <span itemprop="keywords">
    
      <a href="/kategorie/#kurs-programowania-java" class="page__taxonomy-item" rel="tag">Kurs programowania Java</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Ostatnia aktualizacja:</strong> <time datetime="2019-08-27">2019-08-27</time></p>
        
        <p><strong><i class="fas fa-fw fa-child" aria-hidden="true"></i> Autor: </strong><a href="/o-mnie/">Marcin Pietraszek</a></p>
        <hr />
        <p>
          Nie popełnia błędów tylko ten, kto nic nie robi ;). Bardzo możliwe, że znajdziesz błąd, literówkę, coś co wymaga poprawy. Jeśli chcesz możesz samodzielnie 
          <a href="https://github.com/SamouczekProgramisty/samouczekprogramisty.github.io/edit/source/_posts/2019-02-11-watki-w-jezyku-java.md">poprawić tę stronę</a>. Jeśli nie chcesz poprawiać błędu, który udało Ci się znaleźć będę wdzięczny jeśli go 
          <a href="https://github.com/SamouczekProgramisty/samouczekprogramisty.github.io/issues/new?title=Błąd%20na%20stronie:%20_posts/2019-02-11-watki-w-jezyku-java.md">zgłosisz</a>. Z góry dziękuję!
        </p>
      </footer>
    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Zostaw komentarz</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">Także może Ci się spodobać</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2019/04/20_jak_pisac_dobry_kod_w_javie_artykul.jpeg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/jak-pisac-kod-wysokiej-jakosci-w-jezyku-java/" rel="permalink">Jak pisać kod wysokiej jakości w języku Java
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          17 minut(y)
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">W artykule przeczytasz o tym czym jest konwencja nazewnicza. Dowiesz się jak jej stosować. Na przykładach pokażę Ci najczęściej popełniane błędy wraz z propo...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2019/09/21_podstawy_uml_artykul.jpeg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/podstawy-uml/" rel="permalink">Podstawy UML
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          15 minut(y)
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">W artykule opisuję podstawy UML. Po lekturze tego artykułu poznasz kilka rodzajów diagramów, które moim zdaniem są najbardziej przydatne. Dowiesz się w jakic...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2016/11/28_wyrazenia_regularne_artykul.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/wyrazenia-regularne-w-jezyku-java/" rel="permalink">Wyrażenia regularne w języku Java
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          16 minut(y)
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Artykuł ten poświęcony jest wyrażeniom regularnym. Dowiesz się w nim czym są wyrażenia regularne, jak i kiedy ich używać. Poznasz klasy biblioteki standardow...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/2018/01/30_strumienie_w_jezyku_java_artykul.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/strumienie-w-jezyku-java/" rel="permalink">Strumienie w języku Java
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          11 minut(y)
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">W artykule tym przeczytasz o strumieniach w języku Java. Dowiesz się czym są strumienie, poznasz podstawowe operacje na strumieniach. Wszystko jak zwykle pop...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><div class="search-searchbar"></div>
  <div class="search-hits"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">

    
      <li><strong>Śledź:</strong></li>
    

    
      
        
          <li><a href="https://www.facebook.com/SamouczekProgramisty" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i> Facebook</a></li>
        
      
        
          <li><a href="https://github.com/SamouczekProgramisty" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.youtube.com/channel/UCisPQ5nxB6yw3SfJPFWKTEg" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i> YouTube</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>

  <ul>
    <li><a href="https://www.samouczekprogramisty.pl/o-mnie/">O mnie</a></li>
    <li><a href="https://www.samouczekprogramisty.pl/o-blogu/">O blogu</a></li>
    <li><a href="https://www.samouczekprogramisty.pl/polityka-prywatnosci/">Polityka prywatności</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2015-2022 Marcin Pietraszek</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>


<!-- Including InstantSearch.js library and styling -->
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3.3/dist/instantsearch.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3.3/dist/instantsearch.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3.3/dist/instantsearch-theme-algolia.min.css">

<script>
// Instanciating InstantSearch.js with Algolia credentials
const search = instantsearch({
  appId: 'BAIWADE3K7',
  apiKey: '4a78df6a4d9f820ebbdb0a35f834b174',
  indexName: 'prod_samouczek',
  searchParameters: {
    restrictSearchableAttributes: [
      'title',
      'content'
    ]
  }
});

const hitTemplate = function(hit) {
  const url = hit.url;
  const title = hit._highlightResult.title.value;
  const content = hit._highlightResult.html.value;

  return `
    <div class="list__item">
      <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
        <h2 class="archive__item-title" itemprop="headline"><a href="${url}">${title}</a></h2>
        <div class="archive__item-excerpt" itemprop="description">${content}</div>
      </article>
    </div>
  `;
}

// Adding searchbar and results widgets
search.addWidget(
  instantsearch.widgets.searchBox({
    container: '.search-searchbar',
    poweredBy: true,
    placeholder: 'Szukaj...'
  })
);
search.addWidget(
  instantsearch.widgets.hits({
    container: '.search-hits',
    templates: {
      item: hitTemplate,
      empty: 'Brak wyników',
    }
  })
);

// Starting the search only when toggle is clicked
$(document).ready(function () {
  $(".search__toggle").on("click", function() {
    if(!search.started) {
      search.start();
    }
  });
});
</script>





  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XZ470HJYWP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XZ470HJYWP', { 'anonymize_ip': true});
</script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "https://www.samouczekprogramisty.pl/watki-w-jezyku-java/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = ""; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://samouczekprogramisty.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Proszę włacz obsługę JavaScript żeby móc zobaczyć komentarze.</noscript>


  





  </body>
</html>
